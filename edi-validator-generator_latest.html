<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>837 EDI Test Data Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Manrope:wght@300;500;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --accent: #ec4899;
            --error: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #475569;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 15% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 85% 80%, rgba(168, 85, 247, 0.1) 0%, transparent 40%);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2.5rem 0;
            border-bottom: 2px solid var(--border);
            position: relative;
        }

        h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0;
        }

        .tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-family: 'Manrope', sans-serif;
            position: relative;
            bottom: -2px;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 968px) {
            .grid { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.2);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
        }

        .icon {
            width: 28px;
            height: 28px;
            stroke: var(--primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        select, input[type="number"], input[type="text"], textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
        }

        textarea {
            min-height: 200px;
            font-size: 0.85rem;
            line-height: 1.5;
            resize: vertical;
        }

        .checkbox-group {
            display: grid;
            gap: 0.875rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.08);
        }

        .checkbox-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            margin-right: 1rem;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            font-weight: 500;
            color: var(--text-primary);
            text-transform: none;
            letter-spacing: normal;
        }

        .error-severity {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: auto;
            letter-spacing: 0.05em;
        }

        .severity-critical { background: rgba(239, 68, 68, 0.2); color: var(--error); }
        .severity-high { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .severity-medium { background: rgba(59, 130, 246, 0.2); color: var(--info); }
        .severity-low { background: rgba(16, 185, 129, 0.2); color: var(--success); }

        .btn {
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Manrope', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.5);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .btn-validate {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-validate:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.5);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .stat-card {
            background: var(--bg-input);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .output-section {
            margin-top: 2rem;
            display: none;
        }

        .output-section.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .output-area {
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .validation-results {
            margin-top: 2rem;
        }

        .validation-item {
            background: var(--bg-input);
            border-left: 4px solid;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            animation: slideIn 0.3s ease;
        }

        .validation-item.error { border-left-color: var(--error); }
        .validation-item.warning { border-left-color: var(--warning); }
        .validation-item.success { border-left-color: var(--success); }

        .validation-item.hidden {
            display: none;
        }

        .validation-item.filtered-out {
            opacity: 0.3;
            pointer-events: none;
        }

        .filter-info {
            background: rgba(99, 102, 241, 0.1);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .filter-info.active {
            display: flex;
        }

        .filter-text {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
        }

        .clear-filter-btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-family: 'Manrope', sans-serif;
        }

        .clear-filter-btn:hover {
            background: var(--primary);
            color: white;
        }

        .validation-item-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .validation-type {
            font-weight: 700;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .validation-item.error .validation-type { color: var(--error); }
        .validation-item.warning .validation-type { color: var(--warning); }
        .validation-item.success .validation-type { color: var(--success); }

        .validation-message {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .validation-location {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .validation-recommendation {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .recommendation-content {
            font-size: 0.875rem;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .recommendation-content ul {
            margin: 0.5rem 0 0 1.5rem;
            list-style-type: disc;
        }

        .recommendation-content li {
            margin: 0.25rem 0;
        }

        .code-example {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            margin: 0.75rem 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            overflow-x: auto;
        }

        .code-example-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .code-correct {
            color: var(--success);
        }

        .code-incorrect {
            color: var(--error);
            text-decoration: line-through;
        }

        .recommendation-steps {
            counter-reset: step-counter;
            list-style: none;
            margin-left: 0;
            padding-left: 0;
        }

        .recommendation-steps li {
            counter-increment: step-counter;
            position: relative;
            padding-left: 2.5rem;
            margin: 1rem 0;
        }

        .recommendation-steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            width: 1.75rem;
            height: 1.75rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .fix-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .btn-fix {
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Manrope', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-fix:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .btn-fix.applied {
            background: var(--bg-input);
            color: var(--success);
            border: 2px solid var(--success);
        }

        .mass-correction-panel {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
            display: none;
        }

        .mass-correction-panel.active {
            display: block;
            animation: slideIn 0.4s ease;
        }

        .correction-group {
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .correction-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .correction-group-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .correction-count {
            background: linear-gradient(135deg, var(--error), #dc2626);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 700;
        }

        .correction-options {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .correction-option {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .correction-option:hover {
            border-color: var(--primary);
        }

        .correction-option input[type="radio"] {
            margin-top: 0.25rem;
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        .correction-option-content {
            flex: 1;
        }

        .correction-option-label {
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: block;
        }

        .correction-option-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .mass-fix-summary {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .mass-fix-summary h4 {
            color: var(--success);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mass-fix-summary ul {
            list-style: none;
            padding: 0;
        }

        .mass-fix-summary li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(16, 185, 129, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mass-fix-summary li:last-child {
            border-bottom: none;
        }

        .fix-count-badge {
            background: var(--success);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .corrected-data-preview {
            background: var(--bg-input);
            border: 2px solid var(--success);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.4s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 0.75rem;
            letter-spacing: 0.05em;
        }

        .badge-new {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            color: white;
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .range-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: var(--bg-input);
            outline: none;
            border: 2px solid var(--border);
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            cursor: pointer;
            border: 3px solid var(--bg-card);
        }

        .range-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            cursor: pointer;
            border: 3px solid var(--bg-card);
        }

        .range-value {
            display: inline-block;
            margin-left: 1rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--primary);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .validation-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--bg-input);
            padding: 1.25rem;
            border-radius: 10px;
            border: 2px solid var(--border);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .summary-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.2);
        }

        .summary-card.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.15);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .summary-card::after {
            content: 'â†’';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: all 0.3s ease;
            color: var(--primary);
            font-weight: 700;
        }

        .summary-card:hover::after {
            opacity: 1;
            right: 0.75rem;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
        }

        .summary-card.error .summary-value { color: var(--error); }
        .summary-card.warning .summary-value { color: var(--warning); }
        .summary-card.success .summary-value { color: var(--success); }

        .summary-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .error-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.3s ease;
        }

        .error-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .error-card-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }

        .error-card-body {
            font-size: 0.9rem;
            line-height: 1.8;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .error-card-body strong {
            color: var(--text-primary);
            font-weight: 700;
        }

        .error-card-tag {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.4rem 1rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            background: var(--error);
            color: white;
        }

        .btn-fix {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            font-family: 'Manrope', sans-serif;
        }

        .btn-fix:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-fix:disabled,
        .btn-fix.applied {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            cursor: not-allowed;
            transform: none;
        }

        .btn-fix.applied {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="background-pattern"></div>
    <div class="container">
        <header>
            <h1>837 EDI Test Data Generator</h1>
            <p class="subtitle">Generate Professional, Institutional, and Dental test data with configurable error scenarios</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('generate')">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; margin-right: 0.5rem;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Generate Data
            </button>
            <button class="tab" onclick="switchTab('validate')">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; margin-right: 0.5rem;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Validate
            </button>
            <button class="tab" onclick="switchTab('dashboard')">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; margin-right: 0.5rem;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Error Dashboard
            </button>
        </div>

        <!-- Generate Tab -->
        <div id="generateTab" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h2>
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Configuration
                    </h2>

                    <div class="form-group">
                        <label>837 Format Type</label>
                        <select id="formatType">
                            <option value="professional">837-Professional (837P)</option>
                            <option value="institutional">837-Institutional (837I)</option>
                            <option value="dental">837-Dental (837D)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Data Quality Profile</label>
                        <select id="qualityProfile">
                            <option value="clean">Clean Data (No Errors)</option>
                            <option value="mapping">Mapping Issues</option>
                            <option value="validation">Validation Errors</option>
                            <option value="mixed">Mixed Errors</option>
                            <option value="custom">Custom Configuration</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Number of Claims/Encounters</label>
                        <input type="range" id="claimCount" class="range-slider" min="1" max="100" value="10">
                        <span class="range-value" id="claimCountValue">10</span>
                    </div>

                    <div class="form-group">
                        <label>Service Lines per Claim</label>
                        <input type="range" id="serviceLines" class="range-slider" min="1" max="20" value="3">
                        <span class="range-value" id="serviceLinesValue">3</span>
                    </div>

                    <div class="info-box">
                        ðŸ’¡ <strong>Tip:</strong> Generated data can be validated immediately using the Validate tab.
                    </div>
                </div>

                <div class="card" id="errorTypesPanel" style="display: none;">
                    <h2>
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        Error Configuration
                        <span class="badge badge-new">Custom</span>
                    </h2>

                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="missing-required" checked>
                            <label for="missing-required">Missing Required Fields</label>
                            <span class="error-severity severity-critical">CRITICAL</span>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="wrong-loop">
                            <label for="wrong-loop">Wrong Loop Position</label>
                            <span class="error-severity severity-high">HIGH</span>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="invalid-codes">
                            <label for="invalid-codes">Invalid Code Values</label>
                            <span class="error-severity severity-high">HIGH</span>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="length-violation">
                            <label for="length-violation">Length Violations</label>
                            <span class="error-severity severity-medium">MEDIUM</span>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="date-errors">
                            <label for="date-errors">Date/Time Errors</label>
                            <span class="error-severity severity-medium">MEDIUM</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generateData()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Generate Test Data
                </button>
                <button class="btn btn-secondary" onclick="resetForm()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Reset
                </button>
            </div>

            <div class="stats" id="statsSection" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="totalClaims">0</div>
                    <div class="stat-label">Total Claims</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSegments">0</div>
                    <div class="stat-label">Total Segments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="errorCount">0</div>
                    <div class="stat-label">Injected Errors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="fileSize">0 KB</div>
                    <div class="stat-label">File Size</div>
                </div>
            </div>

            <div class="output-section" id="outputSection">
                <div class="card">
                    <h2>
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Generated EDI File
                    </h2>
                    <div class="output-area" id="outputArea"></div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="downloadFile()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download File
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Validate Tab -->
        <div id="validateTab" class="tab-content">
            <div class="grid">
                <!-- Input Section -->
                <div class="card">
                    <h2>
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        EDI Data Input
                    </h2>

                    <div class="form-group">
                        <label>EDI Data to Validate</label>
                        <textarea id="validateInput" placeholder="Paste 837 EDI data here or use generated data..."></textarea>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-validate" onclick="runValidation()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Validate
                        </button>
                        <button class="btn btn-secondary" onclick="clearValidationInput()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Clear
                        </button>
                        <button class="btn btn-secondary" onclick="useGeneratedData()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path>
                            </svg>
                            Use Generated Data
                        </button>
                    </div>
                </div>

                <!-- Validation Results -->
                <div class="card" id="validationResultsCard" style="display: none;">
                    <h2>
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                        Validation Summary
                    </h2>

                    <div class="validation-summary" id="validationSummaryCards"></div>

                    <!-- Download Clean File - shown when errors = 0 -->
                    <div id="downloadCleanBtnGroup" style="display:none; margin-top:1.25rem;">
                        <button id="downloadCleanBtn" onclick="downloadCleanFile()" style="
                            background:linear-gradient(135deg, #10b981, #059669);
                            color:white; border:none; padding:0.85rem 1.5rem; border-radius:10px;
                            font-weight:700; cursor:pointer; font-size:0.95rem; font-family:'Manrope',sans-serif;
                            display:flex; align-items:center; gap:0.6rem; width:100%; justify-content:center;
                            transition:transform 0.2s, box-shadow 0.2s;
                        " onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(16,185,129,0.35)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
                            <svg style="width:20px;height:20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            <span id="downloadCleanBtnText">Download Clean File</span>
                        </button>
                    </div>

                    <div class="action-buttons" id="massFixButtonGroup" style="display: none;">
                        <button class="btn btn-secondary" onclick="exportValidationReport()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Export Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Individual Errors List -->
            <div class="card" id="errorsListCard" style="display: none;">
                <h2>
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    Individual Errors & Fixes
                </h2>

                <div class="form-group">
                    <label>Filter by Severity</label>
                    <select id="severityFilter" onchange="filterErrors()">
                        <option value="all">All Issues</option>
                        <option value="critical">Critical Only</option>
                        <option value="error">Errors Only</option>
                        <option value="warning">Warnings Only</option>
                        <option value="fixable">Data Fixes (Fixable)</option>
                        <option value="unfixable">Mapping Issues (Unfixable)</option>
                    </select>
                    <button onclick="quickFixAllHI()" id="quickFixHIButton" style="
                        margin-top: 0.5rem;
                        padding: 0.5rem 1rem;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                        width: 100%;
                        display: none;
                    ">
                        âš¡ Quick Fix: Add HI to All Claims
                    </button>
                </div>

                <div id="errorsList"></div>
            </div>
        </div>

        <!-- Error Dashboard Tab -->
        <div id="dashboardTab" class="tab-content">
            <div class="card">
                <h2>
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Error Type Reference Dashboard
                </h2>

                <div class="info-box" style="margin-bottom: 2rem;">
                    This dashboard shows all possible error types that can be generated in test data. Use this as a reference guide when creating test scenarios.
                </div>

                <!-- Error Categories Grid -->
                <div style="display: grid; gap: 1.5rem;">
                    
                    <!-- Code Errors Section -->
                    <div class="card" style="background: var(--bg-input); border: 2px solid var(--error);">
                        <h3 style="color: var(--error); display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                            <svg style="width: 28px; height: 28px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Code Errors
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div class="error-card">
                                <div class="error-card-header">Invalid Diagnosis Codes</div>
                                <div class="error-card-body">
                                    <strong>Segment:</strong> HI (Health Care Diagnosis Code)<br>
                                    <strong>Example:</strong> HI*ABK:XXXXX~<br>
                                    <strong>Issue:</strong> Non-existent or improperly formatted ICD-10 codes<br>
                                    <strong>Valid Format:</strong> HI*ABK:R079~ (3-7 characters)
                                </div>
                                <div class="error-card-tag">CRITICAL</div>
                            </div>

                            <div class="error-card">
                                <div class="error-card-header">Invalid Procedure Codes</div>
                                <div class="error-card-body">
                                    <strong>Segment:</strong> SV1 (Professional Service)<br>
                                    <strong>Example:</strong> SV1*HC:INVALID*100.00~<br>
                                    <strong>Issue:</strong> Invalid CPT/HCPCS procedure codes<br>
                                    <strong>Valid Format:</strong> SV1*HC:99213*100.00~
                                </div>
                                <div class="error-card-tag">CRITICAL</div>
                            </div>

                            <div class="error-card">
                                <div class="error-card-header">Invalid Authorization Qualifier</div>
                                <div class="error-card-body">
                                    <strong>Segment:</strong> ISA01<br>
                                    <strong>Example:</strong> ISA*99*<br>
                                    <strong>Issue:</strong> Invalid authorization information qualifier<br>
                                    <strong>Valid Values:</strong> 00, 03
                                </div>
                                <div class="error-card-tag">ERROR</div>
                            </div>
                        </div>
                    </div>

                    <!-- Date/Time Errors Section -->
                    <div class="card" style="background: var(--bg-input); border: 2px solid var(--warning);">
                        <h3 style="color: var(--warning); display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                            <svg style="width: 28px; height: 28px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Date & Time Errors
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div class="error-card">
                                <div class="error-card-header">Invalid Date Format</div>
                                <div class="error-card-body">
                                    <strong>Segment:</strong> DTP (Date/Time Period)<br>
                                    <strong>Example:</strong> DTP*472*D8*20991301~<br>
                                    <strong>Issue:</strong> Month 13 doesn't exist<br>
                                    <strong>Valid Format:</strong> CCYYMMDD (e.g., 20250115)
                                </div>
                                <div class="error-card-tag">ERROR</div>
                            </div>

                            <div class="error-card">
                                <div class="error-card-header">Future Date Error</div>
                                <div class="error-card-body">
                                    <strong>Segment:</strong> DTP03<br>
                                    <strong>Example:</strong> DTP*472*D8*20991231~<br>
                                    <strong>Issue:</strong> Service date in the future<br>
                                    <strong>Rule:</strong> Service dates cannot exceed current date
                                </div>
                                <div class="error-card-tag">WARNING</div>
                            </div>

                            <div class="error-card">
                                <div class="error-card-header">Wrong Date Length</div>
                                <div class="error-card-body">
                                    <strong>Segment:</strong> DTP, ISA, GS<br>
                                    <strong>Example:</strong> DTP*472*D8*250115~ (6 digits)<br>
                                    <strong>Issue:</strong> Should be 8 digits for D8 qualifier<br>
                                    <strong>Valid:</strong> 20250115
                                </div>
                                <div class="error-card-tag">ERROR</div>
                            </div>
                        </div>
                    </div>

                    <!-- Amount Errors Section -->
                    <div class="card" style="background: var(--bg-input); border: 2px solid var(--accent);">
                        <h3 style="color: var(--accent); display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                            <svg style="width: 28px; height: 28px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Amount Errors
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div class="error-card">
                                <div class="error-card-header">Negative Amount</div>
                                <div class="error-card-body">
                                    <strong>Segment:</strong> CLM02, SV102<br>
                                    <strong>Example:</strong> CLM*CLM001*-100.00~<br>
                                    <strong>Issue:</strong> Claim amounts cannot be negative<br>
                                    <strong>Valid:</strong> Positive numbers with up to 2 decimals
                                </div>
                                <div class="error-card-tag">ERROR</div>
                            </div>

                            <div class="error-card">
                                <div class="error-card-header">Invalid Decimal Format</div>
                                <div class="error-card-body">
                                    <strong>Segment:</strong> CLM02, SV102<br>
                                    <strong>Example:</strong> CLM*CLM001*100.999~<br>
                                    <strong>Issue:</strong> More than 2 decimal places<br>
                                    <strong>Valid Format:</strong> 100.00 or 100.99
                                </div>
                                <div class="error-card-tag">ERROR</div>
                            </div>

                            <div class="error-card">
                                <div class="error-card-header">Zero Amount</div>
                                <div class="error-card-body">
                                    <strong>Segment:</strong> CLM02<br>
                                    <strong>Example:</strong> CLM*CLM001*0.00~<br>
                                    <strong>Issue:</strong> Claim amount should be greater than zero<br>
                                    <strong>Rule:</strong> Minimum $0.01
                                </div>
                                <div class="error-card-tag">WARNING</div>
                            </div>
                        </div>
                    </div>

                    <!-- Mapping/Structure Errors Section -->
                    <div class="card" style="background: var(--bg-input); border: 2px solid var(--info);">
                        <h3 style="color: var(--info); display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                            <svg style="width: 28px; height: 28px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Structure & Mapping Errors
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div class="error-card">
                                <div class="error-card-header">Missing Required Segment</div>
                                <div class="error-card-body">
                                    <strong>Segments:</strong> ISA, GS, ST, CLM, etc.<br>
                                    <strong>Issue:</strong> Required segment not present<br>
                                    <strong>Example:</strong> Missing GS between ISA and ST<br>
                                    <strong>Impact:</strong> File cannot be processed
                                </div>
                                <div class="error-card-tag">CRITICAL</div>
                            </div>

                            <div class="error-card">
                                <div class="error-card-header">Wrong Segment Order</div>
                                <div class="error-card-body">
                                    <strong>Example:</strong> ST appears before GS<br>
                                    <strong>Issue:</strong> Segments out of sequence<br>
                                    <strong>Correct Order:</strong> ISA â†’ GS â†’ ST â†’ BHT...<br>
                                    <strong>Rule:</strong> Must follow HIPAA hierarchy
                                </div>
                                <div class="error-card-tag">CRITICAL</div>
                            </div>

                            <div class="error-card">
                                <div class="error-card-header">Missing Loop Requirement</div>
                                <div class="error-card-body">
                                    <strong>Example:</strong> Missing NM1 in required loop<br>
                                    <strong>Issue:</strong> Required loop not present<br>
                                    <strong>Loops:</strong> 2000A (Billing), 2010AA (Name)<br>
                                    <strong>Rule:</strong> All required loops must be present
                                </div>
                                <div class="error-card-tag">ERROR</div>
                            </div>

                            <div class="error-card">
                                <div class="error-card-header">Incorrect Receiver ID</div>
                                <div class="error-card-body">
                                    <strong>Segment:</strong> ISA08, GS03<br>
                                    <strong>Issue:</strong> Wrong receiver ID for format type<br>
                                    <strong>Professional:</strong> 80882<br>
                                    <strong>Institutional:</strong> 80881<br>
                                    <strong>Dental:</strong> 80880
                                </div>
                                <div class="error-card-tag">WARNING</div>
                            </div>

                            <div class="error-card">
                                <div class="error-card-header">Invalid Version</div>
                                <div class="error-card-body">
                                    <strong>Segment:</strong> ISA12, GS08, ST03<br>
                                    <strong>Issue:</strong> Wrong version number<br>
                                    <strong>ISA12:</strong> 00501<br>
                                    <strong>GS08:</strong> 005010X222A1 (Prof), 005010X223A2 (Inst)
                                </div>
                                <div class="error-card-tag">ERROR</div>
                            </div>

                            <div class="error-card">
                                <div class="error-card-header">Missing Situational Data</div>
                                <div class="error-card-body">
                                    <strong>Example:</strong> Missing PRV segment<br>
                                    <strong>Issue:</strong> Required when certain conditions met<br>
                                    <strong>Rule:</strong> If condition X, then segment Y required<br>
                                    <strong>Common:</strong> PRV, DTP, REF segments
                                </div>
                                <div class="error-card-tag">WARNING</div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                            <svg style="width: 28px; height: 28px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Error Type Summary
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">15</div>
                                <div style="font-size: 1.1rem; opacity: 0.9;">Total Error Types</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">5</div>
                                <div style="font-size: 1.1rem; opacity: 0.9;">Critical Errors</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">7</div>
                                <div style="font-size: 1.1rem; opacity: 0.9;">Standard Errors</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">3</div>
                                <div style="font-size: 1.1rem; opacity: 0.9;">Warnings</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        let generatedData = '';
        let validationResults = null;
        let correctedData = '';
        let originalData = '';
        let appliedFixes = new Set();
        let massCorrections = {};
        let currentFilter = 'all';
        let validationErrors = [];
        let validationWarnings = [];
        let currentValidatedData = '';
        let selectedErrorsToFix = new Set();
        let fixHistory = {}; // Track fixes by error signature
        
        // Create unique key for an error
        function getErrorKey(issue) {
            return `${issue.segment}-${issue.element}-${issue.message}`;
        }
        
        // Record when an error was fixed
        function recordFix(issue, method, details) {
            const key = getErrorKey(issue);
            fixHistory[key] = {
                timestamp: new Date().toLocaleTimeString(),
                method: method, // 'individual', 'mass-fix', 'mapping', 'quick-fix'
                details: details, // What was changed
                severity: issue.severity
            };
            console.log('âœ“ Fix recorded:', fixHistory[key]);
        }
        
        // Check if error was fixed
        function wasFixed(issue) {
            return fixHistory[getErrorKey(issue)];
        }
        
        // Add a fix to history
        function recordFix(issue, method, oldValue, newValue) {
            const fix = {
                timestamp: new Date().toLocaleTimeString(),
                segment: issue.segment,
                element: issue.element,
                severity: issue.severity,
                message: issue.message,
                method: method, // 'individual', 'mass', 'mapping', 'quick-fix'
                oldValue: oldValue,
                newValue: newValue
            };
            fixHistory.push(fix);
            console.log('Fix recorded:', fix);
        } // Track which errors are selected for fixing

        // Initialize event listeners
        document.getElementById('claimCount').addEventListener('input', function() {
            document.getElementById('claimCountValue').textContent = this.value;
        });

        document.getElementById('serviceLines').addEventListener('input', function() {
            document.getElementById('serviceLinesValue').textContent = this.value;
        });

        document.getElementById('qualityProfile').addEventListener('change', function() {
            const isCustom = this.value === 'custom';
            document.getElementById('errorTypesPanel').style.display = isCustom ? 'block' : 'none';
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function copyToValidateTab() {
            // Switch to validate tab
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            tabs[1].classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('validateTab').classList.add('active');
            
            // Copy generated data to validation input
            document.getElementById('validationInput').value = generatedData;
            
            // Show a notification
            showCopyNotification();
        }

        function showCopyNotification() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                background: linear-gradient(135deg, var(--primary), var(--secondary));
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                font-weight: 600;
                animation: slideInRight 0.3s ease;
            `;
            
            toast.innerHTML = `
                <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                Data copied to Validate tab!
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }

        function generateData() {
            const formatType = document.getElementById('formatType').value;
            const qualityProfile = document.getElementById('qualityProfile').value;
            const claimCount = parseInt(document.getElementById('claimCount').value);
            const serviceLines = parseInt(document.getElementById('serviceLines').value);

            document.getElementById('outputSection').classList.add('active');
            document.getElementById('outputArea').innerHTML = '<div class="loading"><div class="spinner"></div>Generating test data...</div>';

            setTimeout(() => {
                const data = generateEDIData(formatType, qualityProfile, claimCount, serviceLines);
                generatedData = data;
                
                document.getElementById('outputArea').textContent = data;
                document.getElementById('statsSection').style.display = 'grid';
                
                const segments = data.split('~').length - 1;
                document.getElementById('totalClaims').textContent = claimCount;
                document.getElementById('totalSegments').textContent = segments;
                document.getElementById('errorCount').textContent = calculateErrors(qualityProfile, claimCount);
                document.getElementById('fileSize').textContent = (new Blob([data]).size / 1024).toFixed(2) + ' KB';
                
                // Show next-step help banner
                var hint = document.getElementById('nextStepHint');
                if (!hint) {
                    hint = document.createElement('div');
                    hint.id = 'nextStepHint';
                    hint.style.cssText = 'margin-top:1.25rem;padding:1rem 1.25rem;background:linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.1));border:1px solid rgba(99,102,241,0.3);border-radius:10px;animation:fadeIn 0.4s ease;';
                    hint.innerHTML = '<div style="display:flex;align-items:flex-start;gap:0.75rem;">' +
                        '<span style="font-size:1.4rem;flex-shrink:0;">ðŸš€</span>' +
                        '<div>' +
                        '<div style="font-weight:700;color:#a78bfa;margin-bottom:0.4rem;font-size:1.05rem;">Next Steps: Validate Your Generated Data</div>' +
                        '<div style="color:var(--text-secondary);font-size:0.9rem;line-height:1.6;">' +
                        '<strong style="color:#c4b5fd;">Step 1:</strong> Click the <strong>Validate</strong> tab above<br>' +
                        '<strong style="color:#c4b5fd;">Step 2:</strong> Click the <strong>"Use Generated Data"</strong> button to load your test data<br>' +
                        '<strong style="color:#c4b5fd;">Step 3:</strong> Click <strong>"Validate"</strong> to check for errors and fix them' +
                        '</div></div></div>';
                    document.getElementById('statsSection').parentNode.insertBefore(hint, document.getElementById('statsSection').nextSibling);
                } else {
                    hint.style.display = 'block';
                }
            }, 1000);
        }

        function generateEDIData(formatType, qualityProfile, claimCount, serviceLines) {
            const receiverId = formatType === 'professional' ? '80882' : 
                              formatType === 'institutional' ? '80881' : '80880';
            
            let ediData = '';
            const timestamp = new Date();
            const dateStr = timestamp.toISOString().slice(2,10).replace(/-/g, ''); // YYMMDD format
            const timeStr = timestamp.toTimeString().slice(0,5).replace(':', '');
            const controlNum = Math.floor(Math.random() * 999999999);

            // ISA Segment
            ediData += `ISA*00*          *00*          *ZZ*SENDER12345    *ZZ*${receiverId.padEnd(15)}*${dateStr}*${timeStr}*^*00501*${controlNum.toString().padStart(9, '0')}*0*P*:~\n`;
            
            // GS Segment
            const gsControlNum = Math.floor(Math.random() * 9999);
            ediData += `GS*HC*SENDER12345*${receiverId}*${dateStr}*${timeStr}*${gsControlNum}*X*005010X222A1~\n`;

            // Generate claims
            for (let i = 0; i < claimCount; i++) {
                ediData += generateClaim(formatType, qualityProfile, i + 1, serviceLines);
            }

            // GE Segment
            ediData += `GE*${claimCount}*${gsControlNum}~\n`;
            
            // IEA Segment
            ediData += `IEA*1*${controlNum.toString().padStart(9, '0')}~\n`;

            return ediData;
        }

        function generateClaim(formatType, qualityProfile, claimNum, serviceLines) {
            let claim = '';
            const stControlNum = 1000 + claimNum;
            const currentDate = new Date().toISOString().slice(0,10).replace(/-/g, '');
            
            // ST - Transaction Set Header
            claim += `ST*837*${stControlNum.toString().padStart(4, '0')}*005010X222A1~\n`;
            
            // BHT - Beginning of Hierarchical Transaction
            const bhtRef = `TEST${claimNum.toString().padStart(6, '0')}`;
            claim += `BHT*0019*00*${bhtRef}*${currentDate}*${new Date().toTimeString().slice(0,4).replace(':', '')}*CH~\n`;

            // NM1 - Submitter (Loop 1000A)
            claim += `NM1*41*2*TEST SUBMITTER*****46*SUBID123~\n`;
            claim += `PER*IC*CONTACT NAME*TE*5551234567~\n`;

            // NM1 - Receiver (Loop 1000B)
            claim += `NM1*40*2*${formatType.toUpperCase()} RECEIVER*****46*RECID456~\n`;

            // HL - Billing Provider (Loop 2000A)
            claim += `HL*1**20*1~\n`;
            
            // PRV segment - conditionally exclude for mapping errors
            if (qualityProfile === 'mapping' || qualityProfile === 'mixed') {
                // Intentionally omit PRV segment for mapping errors
                // This creates a structure/mapping issue
            } else {
                claim += `PRV*BI*PXC*207Q00000X~\n`;
            }
            
            claim += `NM1*85*2*BILLING PROVIDER*****XX*1234567890~\n`;
            claim += `N3*123 PROVIDER STREET~\n`;
            claim += `N4*CITY*CA*12345~\n`;
            claim += `REF*EI*123456789~\n`;

            // HL - Subscriber (Loop 2000B)
            claim += `HL*2*1*22*0~\n`;
            claim += `SBR*P*18*******MC~\n`;
            claim += `NM1*IL*1*DOE*JOHN****MI*MEM${claimNum.toString().padStart(9, '0')}~\n`;
            claim += `N3*456 MEMBER STREET~\n`;
            claim += `N4*CITY*CA*54321~\n`;
            claim += `DMG*D8*19800115*M~\n`;

            // NM1 - Payer (Loop 2010BB)
            claim += `NM1*PR*2*PAYER NAME*****PI*PAYER123~\n`;

            // CLM - Claim Information (Loop 2300)
            const claimId = `CLM${claimNum.toString().padStart(10, '0')}`;
            let claimAmount = (Math.random() * 1000 + 100).toFixed(2);
            
            // For validation errors, inject negative amount
            if (qualityProfile === 'validation' || qualityProfile === 'mixed') {
                if (claimNum % 3 === 0) {
                    claimAmount = '-' + claimAmount; // Negative amount error
                }
            }
            
            claim += `CLM*${claimId}*${claimAmount}***11:B:1*Y*A*Y*Y~\n`;
            
            // DTP segments - handle based on quality profile
            if (qualityProfile === 'validation') {
                // Inject invalid date for validation errors
                claim += `DTP*472*D8*20991301~\n`; // Invalid date (month 13)
                claim += `DTP*096*D8*20991301~\n`; // Another invalid date
            } else if (qualityProfile === 'mapping') {
                // Intentionally omit DTP*472 (required) but include DTP*096 (optional)
                // This creates mapping error: missing required segment
                claim += `DTP*096*D8*${currentDate}~\n`; // Wrong DTP qualifier
            } else if (qualityProfile === 'mixed') {
                // Mix of valid and mapping issues
                if (claimNum % 2 === 0) {
                    claim += `DTP*472*D8*${currentDate}~\n`; // Valid
                } else {
                    // Missing required DTP - mapping error
                }
            } else {
                // Clean data - use valid required DTPs
                claim += `DTP*472*D8*${currentDate}~\n`;
                claim += `DTP*096*D8*${currentDate}~\n`;
            }

            // HI - Diagnosis codes
            if (qualityProfile === 'validation') {
                claim += `HI*ABK:XXXXX~\n`; // Invalid code
            } else if (qualityProfile === 'mapping') {
                // Missing HI segment completely - mapping error
                // This creates a critical structure issue
            } else if (qualityProfile === 'mixed') {
                if (claimNum % 2 === 0) {
                    claim += `HI*ABK:R079~\n`; // Valid
                } else {
                    // Missing HI - mapping error
                }
            } else {
                claim += `HI*ABK:R079~\n`; // Valid ICD-10
            }

            // Service lines (Loop 2400)
            for (let j = 0; j < serviceLines; j++) {
                const lineNum = j + 1;
                claim += `LX*${lineNum}~\n`;
                
                // Determine procedure code and amount based on quality profile
                let procedureCode = '99213'; // Default valid CPT
                let lineAmount = (Math.random() * 200 + 50).toFixed(2);
                
                if (qualityProfile === 'validation') {
                    if (j === 0) {
                        procedureCode = 'XXXXX'; // Invalid code
                        lineAmount = '-' + lineAmount; // Negative amount
                    }
                } else if (qualityProfile === 'mapping') {
                    // Use valid codes but omit required segments below
                    procedureCode = ['99213', '99214', '99215', '99203', '99204'][j % 5];
                } else if (qualityProfile === 'mixed') {
                    if (claimNum % 3 === 0 && j === 0) {
                        procedureCode = 'INVALID'; // Validation error
                    } else {
                        procedureCode = ['99213', '99214', '99215'][j % 3];
                    }
                }
                
                claim += `SV1*HC:${procedureCode}*${lineAmount}*UN*1***1~\n`;
                
                // DTP at service line level - handle mapping errors
                if (qualityProfile === 'mapping') {
                    // Intentionally omit DTP*472 at service line level
                    // This creates mapping error: missing required service date
                } else if (qualityProfile === 'mixed') {
                    if (j % 2 === 0) {
                        claim += `DTP*472*D8*${currentDate}~\n`;
                    }
                    // Else omit for mapping error
                } else if (qualityProfile === 'validation') {
                    claim += `DTP*472*D8*20991301~\n`; // Invalid date
                } else {
                    claim += `DTP*472*D8*${currentDate}~\n`; // Valid
                }
                
                // REF segment - conditionally include for mapping test
                if (qualityProfile === 'mapping') {
                    // Omit REF segment that might be required in some scenarios
                } else {
                    claim += `REF*6R*${lineNum}~\n`;
                }
            }

            // SE - Transaction Set Trailer
            const segmentCount = claim.split('~').filter(s => s.trim()).length + 1;
            claim += `SE*${segmentCount}*${stControlNum.toString().padStart(4, '0')}~\n`;

            return claim;
        }

        function calculateErrors(qualityProfile, claimCount) {
            if (qualityProfile === 'clean') return 0;
            if (qualityProfile === 'mapping') return claimCount * 2;
            if (qualityProfile === 'validation') return claimCount * 3;
            if (qualityProfile === 'mixed') return claimCount * 4;
            return Math.floor(Math.random() * claimCount * 5);
        }

        function validateData() {
            const inputData = document.getElementById('validationInput').value.trim();
            const validationType = document.getElementById('validationType').value;

            if (!inputData) {
                alert('Please paste EDI data to validate');
                return;
            }

            // Reset applied fixes when re-validating
            appliedFixes.clear();
            currentFilter = 'all';

            document.getElementById('validationOutput').classList.add('active');
            document.getElementById('validationResults').innerHTML = '<div class="loading"><div class="spinner"></div>Validating data...</div>';
            document.getElementById('correctedDataSection').classList.remove('active');
            document.getElementById('filterInfo').classList.remove('active');

            setTimeout(() => {
                const results = performValidation(inputData, validationType);
                validationResults = results;
                correctedData = inputData; // Initialize with current data
                displayValidationResults(results);
                
                // Show mass correction button if there are errors
                if (results.errors.length > 0 || results.warnings.length > 0) {
                    document.getElementById('massFixButton').style.display = 'flex';
                } else {
                    document.getElementById('massFixButton').style.display = 'none';
                }
                showDownloadBtn(results.errors.length, results.warnings.length);
            }, 1000);
        }

        function performValidation(data, type) {
            const errors = [];
            const warnings = [];
            const segments = data.split('~').filter(s => s.trim());

            // Check ISA segment
            const isaSegment = segments.find(s => s.trim().startsWith('ISA'));
            if (!isaSegment) {
                errors.push({
                    type: 'CRITICAL',
                    message: 'Missing required ISA (Interchange Control Header) segment',
                    location: 'File Header',
                    severity: 'error',
                    recommendation: {
                        summary: 'Add ISA segment at the beginning of the file',
                        steps: [
                            'The ISA segment must be the first segment in any 837 file',
                            'It contains 16 required elements including authorization, security, sender/receiver IDs',
                            'Ensure all elements are exactly the required length (most are fixed-length)'
                        ],
                        example: {
                            correct: 'ISA*00*          *00*          *ZZ*SENDER12345    *ZZ*80882          *250115*1230*^*00501*000000001*0*P*:~'
                        }
                    }
                });
            } else {
                const isaElements = isaSegment.split('*');
                
                // Validate ISA01 - Authorization Information Qualifier
                if (isaElements[1] && !['00', '03'].includes(isaElements[1])) {
                    errors.push({
                        type: 'CODE_ERROR',
                        message: `Invalid Authorization Information Qualifier: "${isaElements[1]}". Must be "00" or "03"`,
                        location: 'ISA01',
                        severity: 'error',
                        recommendation: {
                            summary: 'Use valid Authorization Information Qualifier',
                            steps: [
                                'ISA01 must be exactly 2 characters',
                                'Use "00" for no authorization information present (most common)',
                                'Use "03" only for CMS Tier-2 Testing'
                            ],
                            example: {
                                incorrect: `ISA*${isaElements[1]}*...`,
                                correct: 'ISA*00*          *...'
                            }
                        }
                    });
                }
                
                // Validate ISA12 - Interchange Control Version
                if (isaElements[12] !== '00501') {
                    errors.push({
                        type: 'VERSION_ERROR',
                        message: `Invalid version number: "${isaElements[12]}". Expected "00501" for 5010`,
                        location: 'ISA12',
                        severity: 'error',
                        recommendation: {
                            summary: 'Update to correct 837 version 5010',
                            steps: [
                                'ISA12 must be exactly 5 characters',
                                'For 837 version 5010, use "00501"',
                                'This indicates ASC X12 Standards version 005010'
                            ],
                            example: {
                                incorrect: `ISA*...*${isaElements[12]}*...`,
                                correct: 'ISA*...*00501*...'
                            }
                        }
                    });
                }

                // Validate ISA receiver ID
                const expectedReceiver = type === 'professional' ? '80882' : 
                                       type === 'institutional' ? '80881' : '80880';
                if (isaElements[8] && !isaElements[8].includes(expectedReceiver)) {
                    warnings.push({
                        type: 'RECEIVER_WARNING',
                        message: `Receiver ID may not match expected value for ${type}. Expected: ${expectedReceiver}`,
                        location: 'ISA08',
                        severity: 'warning',
                        recommendation: {
                            summary: 'Verify receiver ID matches intended destination',
                            steps: [
                                `For 837-Professional, use "80882" (right-padded to 15 characters)`,
                                `For 837-Institutional, use "80881" (right-padded to 15 characters)`,
                                `For 837-Dental, use "80880" (right-padded to 15 characters)`,
                                'Ensure ISA08 matches GS03 (same receiver ID)'
                            ],
                            example: {
                                incorrect: `ISA*...*${isaElements[8].trim()}*...`,
                                correct: `ISA*...*${expectedReceiver}          *...`
                            }
                        }
                    });
                }
            }

            // Check GS segment
            const gsSegment = segments.find(s => s.trim().startsWith('GS'));
            if (!gsSegment) {
                errors.push({
                    type: 'CRITICAL',
                    message: 'Missing required GS (Functional Group Header) segment',
                    location: 'File Header',
                    severity: 'error',
                    recommendation: {
                        summary: 'Add GS segment after ISA segment',
                        steps: [
                            'GS segment must appear after ISA and before ST',
                            'GS01 must be "HC" for Health Care Claim (837)',
                            'GS08 must be "005010X222A1" for Professional or "005010X223A2" for Institutional'
                        ],
                        example: {
                            correct: 'GS*HC*SENDER12345*80882*20250115*1230*1*X*005010X222A1~'
                        }
                    }
                });
            }

            // Check ST segment - look for ST segments that start with ST*837
            const stSegments = segments.filter(s => {
                const trimmed = s.trim();
                return trimmed.startsWith('ST*') && trimmed.includes('*837*');
            });
            
            if (stSegments.length === 0) {
                errors.push({
                    type: 'CRITICAL',
                    message: 'No ST (Transaction Set Header) segments found',
                    location: 'Transaction Set',
                    severity: 'error',
                    recommendation: {
                        summary: 'Add ST segment to start each transaction set',
                        steps: [
                            'Each claim/encounter must begin with an ST segment',
                            'ST01 must be "837" for claim transactions',
                            'ST02 should be a unique control number (typically 4 digits)',
                            'ST03 should match GS08 implementation guide version'
                        ],
                        example: {
                            correct: 'ST*837*0001*005010X222A1~'
                        }
                    }
                });
            }

            // Check CLM segments
            const clmSegments = segments.filter(s => s.startsWith('CLM'));
            clmSegments.forEach((clm, idx) => {
                const elements = clm.split('*');
                
                // Validate claim amount
                if (elements[2]) {
                    const amount = parseFloat(elements[2]);
                    if (isNaN(amount) || amount <= 0) {
                        errors.push({
                            type: 'AMOUNT_ERROR',
                            message: `Invalid claim amount: "${elements[2]}" in claim ${idx + 1}`,
                            location: `CLM02 (Claim ${idx + 1})`,
                            severity: 'error',
                            recommendation: {
                                summary: 'Provide valid numeric claim amount',
                                steps: [
                                    'CLM02 must be a valid decimal number greater than 0',
                                    'Format: dollars and cents with decimal point (e.g., 150.00)',
                                    'Do not include currency symbols or commas',
                                    'Maximum 18 digits total including decimal'
                                ],
                                example: {
                                    incorrect: `CLM*CLM000001*${elements[2]}*...`,
                                    correct: 'CLM*CLM000001*250.75*...'
                                }
                            }
                        });
                    }
                }
            });

            // Check DTP segments for date validation
            const dtpSegments = segments.filter(s => s.startsWith('DTP'));
            dtpSegments.forEach((dtp, idx) => {
                const elements = dtp.split('*');
                if (elements[3]) {
                    const dateStr = elements[3];
                    if (dateStr.length !== 8 && dateStr.length !== 6) {
                        errors.push({
                            type: 'DATE_ERROR',
                            message: `Invalid date format: "${dateStr}". Expected CCYYMMDD or YYMMDD`,
                            location: `DTP03 (Occurrence ${idx + 1})`,
                            severity: 'error',
                            recommendation: {
                                summary: 'Use correct date format',
                                steps: [
                                    'When DTP02 = "D8", use CCYYMMDD format (8 digits)',
                                    'Example: January 15, 2025 = 20250115',
                                    'When DTP02 = "D6", use YYMMDD format (6 digits)',
                                    'Ensure month is 01-12 and day is valid for that month'
                                ],
                                example: {
                                    incorrect: `DTP*472*D8*${dateStr}~`,
                                    correct: 'DTP*472*D8*20250115~'
                                }
                            }
                        });
                    }
                    
                    // Check for obviously invalid dates
                    if (dateStr.length === 8) {
                        const year = parseInt(dateStr.substring(0, 4));
                        const month = parseInt(dateStr.substring(4, 6));
                        const day = parseInt(dateStr.substring(6, 8));
                        
                        if (year > 2099 || year < 1900 || month > 12 || month < 1 || day > 31 || day < 1) {
                            errors.push({
                                type: 'DATE_ERROR',
                                message: `Invalid date value: "${dateStr}"`,
                                location: `DTP03 (Occurrence ${idx + 1})`,
                                severity: 'error',
                                recommendation: {
                                    summary: 'Correct invalid date components',
                                    steps: [
                                        `Year must be between 1900 and 2099 (found: ${year})`,
                                        `Month must be between 01 and 12 (found: ${month.toString().padStart(2, '0')})`,
                                        `Day must be between 01 and 31 (found: ${day.toString().padStart(2, '0')})`,
                                        'Verify the date is valid (e.g., no February 30th)'
                                    ],
                                    example: {
                                        incorrect: `DTP*472*D8*${dateStr}~`,
                                        correct: 'DTP*472*D8*20250115~ (January 15, 2025)'
                                    }
                                }
                            });
                        }
                    }
                }
            });

            // Check HI segments for diagnosis codes
            const hiSegments = segments.filter(s => s.startsWith('HI'));
            hiSegments.forEach((hi, idx) => {
                const elements = hi.split('*');
                elements.slice(1).forEach((elem, elemIdx) => {
                    if (elem) {
                        const parts = elem.split(':');
                        if (parts.length >= 2) {
                            const qualifier = parts[0];
                            const code = parts[1];
                            
                            // Simple validation - check if it looks like a valid diagnosis code format
                            if (code.length < 3 || code.length > 7) {
                                warnings.push({
                                    type: 'CODE_WARNING',
                                    message: `Diagnosis code "${code}" has unusual length`,
                                    location: `HI0${elemIdx + 1} (Occurrence ${idx + 1})`,
                                    severity: 'warning',
                                    recommendation: {
                                        summary: 'Verify diagnosis code length and format',
                                        steps: [
                                            'ICD-10-CM codes should be 3-7 characters',
                                            'Format: Category (3 chars) + optional subcategory (up to 4 chars)',
                                            'Example: A01.0, Z23, J44.1, E11.65, R079',
                                            'Verify code exists in current ICD-10-CM code set'
                                        ],
                                        example: {
                                            incorrect: `HI*${qualifier}:${code}~`,
                                            correct: 'HI*ABK:R079~ (ICD-10 code for fever)'
                                        }
                                    }
                                });
                            }
                            // Check for obviously invalid codes (exclude valid test codes)
                            if (/^X+$/.test(code) || code === 'INVALID') {
                                errors.push({
                                    type: 'CODE_ERROR',
                                    message: `Invalid diagnosis code: "${code}"`,
                                    location: `HI0${elemIdx + 1} (Occurrence ${idx + 1})`,
                                    severity: 'error',
                                    recommendation: {
                                        summary: 'Replace with valid ICD-10-CM diagnosis code',
                                        steps: [
                                            'Use valid ICD-10-CM codes from the current year code set',
                                            'Qualifier ABK is for ICD-10-CM codes',
                                            'First diagnosis (HI01) is the principal/primary diagnosis',
                                            'Common valid codes: R079 (fever), Z9989 (encounter), Z00.00 (general exam)'
                                        ],
                                        example: {
                                            incorrect: `HI*ABK:${code}~`,
                                            correct: 'HI*ABK:R079~'
                                        }
                                    }
                                });
                            }
                        }
                    }
                });
            });

            // Check SV1 segments for procedure codes
            const sv1Segments = segments.filter(s => s.startsWith('SV1'));
            sv1Segments.forEach((sv1, idx) => {
                const elements = sv1.split('*');
                if (elements[1]) {
                    const fullCode = elements[1];
                    const codeParts = fullCode.split(':');
                    const qualifier = codeParts[0];
                    const procCode = codeParts[1] || fullCode;
                    
                    // Check for obviously invalid codes
                    if (/^X+$/.test(procCode) || procCode === 'INVALID') {
                        errors.push({
                            type: 'CODE_ERROR',
                            message: `Invalid procedure code: "${procCode}"`,
                            location: `SV101 (Service Line ${idx + 1})`,
                            severity: 'error',
                            recommendation: {
                                summary: 'Replace with valid procedure code',
                                steps: [
                                    'Use appropriate procedure code type based on service',
                                    'HC qualifier = HCPCS/CPT codes (most common for professional)',
                                    'CPT codes: 5 digits (e.g., 99213, 99214)',
                                    'HCPCS codes: 1 letter + 4 digits (e.g., J0690)',
                                    'Verify code is valid in current CPT/HCPCS code set'
                                ],
                                example: {
                                    incorrect: `SV1*HC:${procCode}*...`,
                                    correct: 'SV1*HC:99213*100.00*UN*1***1~'
                                }
                            }
                        });
                    }
                }
                
                // Validate line amount
                if (elements[2]) {
                    const amount = parseFloat(elements[2]);
                    if (isNaN(amount) || amount <= 0) {
                        errors.push({
                            type: 'AMOUNT_ERROR',
                            message: `Invalid line amount: "${elements[2]}" in service line ${idx + 1}`,
                            location: `SV102 (Service Line ${idx + 1})`,
                            severity: 'error',
                            recommendation: {
                                summary: 'Provide valid service line charge amount',
                                steps: [
                                    'SV102 must be a valid decimal number greater than 0',
                                    'Represents the charge for this service line',
                                    'Format: dollars and cents (e.g., 75.50)',
                                    'Do not include currency symbols or commas'
                                ],
                                example: {
                                    incorrect: `SV1*HC:99213*${elements[2]}*...`,
                                    correct: 'SV1*HC:99213*100.00*UN*1***1~'
                                }
                            }
                        });
                    }
                }
            });

            return { errors, warnings, totalSegments: segments.length };
        }

        function displayValidationResults(results) {
            const summaryDiv = document.getElementById('validationSummary');
            const resultsDiv = document.getElementById('validationResults');

            // Display summary with click handlers
            summaryDiv.innerHTML = `
                <div class="summary-card error ${currentFilter === 'errors' ? 'active' : ''}" onclick="filterResults('errors')">
                    <div class="summary-value">${results.errors.length}</div>
                    <div class="summary-label">Errors</div>
                </div>
                <div class="summary-card warning ${currentFilter === 'warnings' ? 'active' : ''}" onclick="filterResults('warnings')">
                    <div class="summary-value">${results.warnings.length}</div>
                    <div class="summary-label">Warnings</div>
                </div>
                <div class="summary-card success ${currentFilter === 'segments' ? 'active' : ''}" onclick="filterResults('segments')">
                    <div class="summary-value">${results.totalSegments}</div>
                    <div class="summary-label">Segments Checked</div>
                </div>
                <div class="summary-card ${results.errors.length === 0 ? 'success' : 'error'} ${currentFilter === 'all' ? 'active' : ''}" onclick="filterResults('all')">
                    <div class="summary-value">${results.errors.length === 0 && results.warnings.length === 0 ? 'âœ“' : 'âœ—'}</div>
                    <div class="summary-label">All Results</div>
                </div>
            `;

            // Display detailed results
            let html = '';

            if (results.errors.length === 0 && results.warnings.length === 0) {
                html = `
                    <div class="validation-item success">
                        <div class="validation-item-header">
                            <svg style="width: 24px; height: 24px; stroke: var(--success);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="validation-type">VALIDATION PASSED</span>
                        </div>
                        <div class="validation-message">No errors or warnings found. The EDI data appears to be valid according to EDPS 837 v5010 specifications.</div>
                    </div>
                `;
            } else {
                results.errors.forEach((err, idx) => {
                    html += `
                        <div class="validation-item error" data-type="error">
                            <div class="validation-item-header">
                                <svg style="width: 24px; height: 24px; stroke: var(--error);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="validation-type">${err.type}</span>
                            </div>
                            <div class="validation-message">${err.message}</div>
                            <div class="validation-location">ðŸ“ Location: ${err.location}</div>
                            ${generateRecommendation(err.recommendation, idx)}
                        </div>
                    `;
                });

                results.warnings.forEach((warn, idx) => {
                    const warnIndex = results.errors.length + idx;
                    html += `
                        <div class="validation-item warning" data-type="warning">
                            <div class="validation-item-header">
                                <svg style="width: 24px; height: 24px; stroke: var(--warning);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <span class="validation-type">${warn.type}</span>
                            </div>
                            <div class="validation-message">${warn.message}</div>
                            <div class="validation-location">ðŸ“ Location: ${warn.location}</div>
                            ${generateRecommendation(warn.recommendation, warnIndex)}
                        </div>
                    `;
                });
            }

            resultsDiv.innerHTML = html;
            applyCurrentFilter();
        }

        function generateRecommendation(rec, errorIndex) {
            if (!rec) return '';

            let stepsHtml = '';
            if (rec.steps && rec.steps.length > 0) {
                stepsHtml = '<ol class="recommendation-steps">';
                rec.steps.forEach(step => {
                    stepsHtml += `<li>${step}</li>`;
                });
                stepsHtml += '</ol>';
            }

            let exampleHtml = '';
            if (rec.example) {
                if (rec.example.incorrect) {
                    exampleHtml += `
                        <div class="code-example">
                            <div class="code-example-label">âŒ Incorrect:</div>
                            <code class="code-incorrect">${escapeHtml(rec.example.incorrect)}</code>
                        </div>
                    `;
                }
                if (rec.example.correct) {
                    exampleHtml += `
                        <div class="code-example">
                            <div class="code-example-label">âœ… Correct:</div>
                            <code class="code-correct">${escapeHtml(rec.example.correct)}</code>
                        </div>
                    `;
                }
            }

            const fixId = `fix-${errorIndex}`;
            const isApplied = appliedFixes.has(fixId);

            return `
                <div class="validation-recommendation">
                    <div class="recommendation-header">
                        <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        How to Fix
                    </div>
                    <div class="recommendation-content">
                        <strong>${rec.summary}</strong>
                        ${stepsHtml}
                        ${exampleHtml}
                        <div class="fix-buttons">
                            <button class="btn-fix ${isApplied ? 'applied' : ''}" 
                                    data-fix-id="${fixId}"
                                    onclick="applyFix(${errorIndex}, 'auto')"
                                    ${isApplied ? 'disabled' : ''}>
                                <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isApplied ? 'M5 13l4 4L19 7' : 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z'}"></path>
                                </svg>
                                ${isApplied ? 'Applied' : 'Apply Fix'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function downloadFile() {
            const formatType = document.getElementById('formatType').value;
            const blob = new Blob([generatedData], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `837_${formatType}_test_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function downloadCleanFile() {
            var cleanData = '';
            // Priority: currentValidatedData > correctedData > textarea > generatedData
            if (typeof currentValidatedData !== 'undefined' && currentValidatedData && currentValidatedData.trim()) {
                cleanData = currentValidatedData;
            } else if (typeof correctedData !== 'undefined' && correctedData && correctedData.trim()) {
                cleanData = correctedData;
            } else {
                var el = document.getElementById('validateInput');
                if (el && el.value.trim()) cleanData = el.value;
            }
            if (!cleanData && typeof generatedData !== 'undefined' && generatedData && generatedData.trim()) {
                cleanData = generatedData;
            }
            if (!cleanData) { alert('No data available to download.'); return; }

            var fileType = 'P';
            var fmt = document.getElementById('formatType');
            if (fmt) fileType = fmt.value === 'institutional' ? 'I' : 'P';

            var ts = new Date().toISOString().slice(0,10).replace(/-/g,'');
            var filename = '837' + fileType + '_clean_' + ts + '.txt';
            var blob = new Blob([cleanData], {type:'text/plain;charset=utf-8'});
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(function(){ window.URL.revokeObjectURL(url); document.body.removeChild(a); }, 300);
        }

        function showDownloadBtn(errCount, warnCount) {
            var g = document.getElementById('downloadCleanBtnGroup');
            var t = document.getElementById('downloadCleanBtnText');
            if (!g) return;
            if (errCount === 0) {
                g.style.display = 'block';
                t.textContent = warnCount > 0 ? 'Download File (' + warnCount + ' warnings remain)' : 'Download Clean File';
            } else {
                g.style.display = 'none';
            }
        }

        function resetForm() {
            document.getElementById('formatType').value = 'professional';
            document.getElementById('qualityProfile').value = 'clean';
            document.getElementById('claimCount').value = 10;
            document.getElementById('serviceLines').value = 3;
            document.getElementById('claimCountValue').textContent = '10';
            document.getElementById('serviceLinesValue').textContent = '3';
            document.getElementById('outputSection').classList.remove('active');
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('errorTypesPanel').style.display = 'none';
            var hint = document.getElementById('nextStepHint'); if (hint) hint.style.display = 'none';
            generatedData = '';
        }

        function clearValidation() {
            document.getElementById('validationInput').value = '';
            document.getElementById('validationOutput').classList.remove('active');
            document.getElementById('massFixButton').style.display = 'none';
            document.getElementById('downloadCleanBtnGroup').style.display = 'none';
            document.getElementById('massCorrectionPanel').classList.remove('active');
            document.getElementById('correctedDataSection').classList.remove('active');
            appliedFixes.clear();
            massCorrections = {};
        }

        function applyFix(errorIndex, fixType) {
            const error = [...validationResults.errors, ...validationResults.warnings][errorIndex];
            const fixId = `fix-${errorIndex}`;
            
            if (appliedFixes.has(fixId)) {
                return; // Already applied
            }

            // Store original data if this is the first fix
            if (appliedFixes.size === 0) {
                originalData = document.getElementById('validationInput').value;
            }

            // Get current data from input or use corrected data
            const currentData = document.getElementById('validationInput').value || correctedData;
            
            // Apply the fix
            correctedData = applyCorrection(currentData, error, fixType);
            
            // Update the input field with corrected data
            document.getElementById('validationInput').value = correctedData;
            
            appliedFixes.add(fixId);

            // Update UI
            const button = document.querySelector(`[data-fix-id="${fixId}"]`);
            if (button) {
                button.classList.add('applied');
                button.innerHTML = `
                    <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Applied
                `;
                button.disabled = true;
            }

            // Show success message and preview
            showFixSuccessMessage(error.type);
            
            // Show corrected data preview
            document.getElementById('correctedDataPreview').textContent = correctedData;
            document.getElementById('afterCorrection').textContent = correctedData;
            document.getElementById('beforeCorrection').textContent = originalData;
            document.getElementById('correctedDataSection').classList.add('active');
            
            // Auto re-validate after a short delay
            setTimeout(() => {
                validateCorrectedData();
            }, 1500);
        }

        function applyCorrection(data, error, fixType) {
            let corrected = data;
            console.log('Applying correction for:', error.type, 'at location:', error.location);

            switch (error.type) {
                case 'CODE_ERROR':
                    if (error.location.includes('ISA01')) {
                        // Replace ISA authorization qualifier
                        corrected = corrected.replace(/ISA\*[0-9]{2}\*/, 'ISA*00*');
                    } else if (error.location.includes('ISA03')) {
                        // Replace ISA security qualifier  
                        corrected = corrected.replace(/(ISA\*[^*]*\*[^*]*\*)[0-9]{2}\*/, '$1' + '00*');
                    } else if (error.location.includes('HI0')) {
                        // Replace invalid diagnosis codes - find and replace the specific invalid code
                        const invalidCodeMatch = error.message.match(/Invalid diagnosis code: "([^"]*)"/);
                        if (invalidCodeMatch) {
                            const invalidCode = invalidCodeMatch[1];
                            // Replace the specific invalid code in HI segments
                            const hiPattern = new RegExp(`(HI\\*[^:]*:)${invalidCode.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'g');
                            corrected = corrected.replace(hiPattern, '$1Z9989');
                        } else {
                            // Fallback: replace any obvious invalid patterns
                            corrected = corrected.replace(/HI\*[^:]*:[X]+/g, 'HI*ABK:Z9989');
                            corrected = corrected.replace(/HI\*[^:]*:INVALID/g, 'HI*ABK:Z9989');
                        }
                    } else if (error.location.includes('SV101')) {
                        // Replace invalid procedure codes
                        const invalidCodeMatch = error.message.match(/Invalid procedure code: "([^"]*)"/);
                        if (invalidCodeMatch) {
                            const invalidCode = invalidCodeMatch[1];
                            const sv1Pattern = new RegExp(`(SV1\\*[^:]*:)${invalidCode.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'g');
                            corrected = corrected.replace(sv1Pattern, '$1' + '99213');
                        } else {
                            // Fallback patterns
                            corrected = corrected.replace(/SV1\*[^:]*:[X]+/g, 'SV1*HC:99213');
                            corrected = corrected.replace(/SV1\*[^:]*:INVALID/g, 'SV1*HC:99213');
                        }
                    }
                    break;

                case 'VERSION_ERROR':
                    if (error.location.includes('ISA12')) {
                        // More precise replacement for ISA12
                        corrected = corrected.replace(/(ISA(?:\*[^*]*){11}\*)[^*]*(\*)/g, '$1' + '00501' + '$2');
                    }
                    break;

                case 'RECEIVER_WARNING':
                    if (error.location.includes('ISA08')) {
                        // Extract expected receiver from error message
                        const expectedMatch = error.message.match(/Expected: (\d+)/);
                        if (expectedMatch) {
                            const expectedReceiver = expectedMatch[1].padEnd(15);
                            corrected = corrected.replace(/(ISA(?:\*[^*]*){7}\*)[^*]*(\*)/g, '$1' + expectedReceiver + '$2');
                        }
                    }
                    break;

                case 'DATE_ERROR':
                    if (error.location.includes('DTP03')) {
                        // Extract the invalid date from the error message
                        const invalidDateMatch = error.message.match(/Invalid date (?:format|value): "([^"]*)"/);
                        if (invalidDateMatch) {
                            const invalidDate = invalidDateMatch[1];
                            const today = new Date();
                            const validDate = today.getFullYear() + 
                                          String(today.getMonth() + 1).padStart(2, '0') + 
                                          String(today.getDate()).padStart(2, '0');
                            
                            // Replace the specific invalid date
                            const dtpPattern = new RegExp(`(DTP\\*[^*]*\\*D8\\*)${invalidDate.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'g');
                            corrected = corrected.replace(dtpPattern, '$1' + validDate);
                        } else {
                            // Fallback: fix all DTP dates
                            const today = new Date();
                            const validDate = today.getFullYear() + 
                                          String(today.getMonth() + 1).padStart(2, '0') + 
                                          String(today.getDate()).padStart(2, '0');
                            corrected = corrected.replace(/DTP\*([^*]*)\*D8\*[0-9]{6,8}/g, `DTP*$1*D8*${validDate}`);
                        }
                    }
                    break;

                case 'AMOUNT_ERROR':
                    // Replace invalid amounts
                    if (error.location.includes('CLM02')) {
                        // Extract claim ID from location if available
                        const claimMatch = error.location.match(/Claim (\d+)/);
                        if (claimMatch) {
                            // More targeted replacement - find the specific claim
                            const segments = corrected.split('~');
                            let claimCount = 0;
                            const targetClaim = parseInt(claimMatch[1]);
                            
                            for (let i = 0; i < segments.length; i++) {
                                if (segments[i].trim().startsWith('CLM*')) {
                                    claimCount++;
                                    if (claimCount === targetClaim) {
                                        // Fix this specific claim
                                        const parts = segments[i].split('*');
                                        if (parts.length > 2) {
                                            parts[2] = '100.00';
                                            segments[i] = parts.join('*');
                                        }
                                        break;
                                    }
                                }
                            }
                            corrected = segments.join('~');
                        } else {
                            // Replace all invalid CLM amounts
                            corrected = corrected.replace(/CLM\*([^*]*)\*[^*~]*\*/g, 'CLM*$1*100.00*');
                        }
                    } else if (error.location.includes('SV102')) {
                        // More precise SV1 amount replacement
                        const lineMatch = error.location.match(/Service Line (\d+)/);
                        if (lineMatch) {
                            const segments = corrected.split('~');
                            let lineCount = 0;
                            const targetLine = parseInt(lineMatch[1]);
                            
                            for (let i = 0; i < segments.length; i++) {
                                if (segments[i].trim().startsWith('SV1*')) {
                                    lineCount++;
                                    if (lineCount === targetLine) {
                                        const parts = segments[i].split('*');
                                        if (parts.length > 2) {
                                            parts[2] = '75.00';
                                            segments[i] = parts.join('*');
                                        }
                                        break;
                                    }
                                }
                            }
                            corrected = segments.join('~');
                        } else {
                            corrected = corrected.replace(/(SV1\*[^*]*)\*[^*~]*/g, '$1*75.00');
                        }
                    }
                    break;

                case 'CRITICAL':
                    // Handle missing segments
                    if (error.message.includes('ISA')) {
                        const today = new Date();
                        const dateStr = today.toISOString().slice(2,10).replace(/-/g, '');
                        const timeStr = today.toTimeString().slice(0,4).replace(':', '');
                        const isa = 'ISA*00*          *00*          *ZZ*SENDER12345    *ZZ*80882          *' +
                                  dateStr + '*' + timeStr + '*^*00501*000000001*0*P*:~\n';
                        corrected = isa + corrected;
                    } else if (error.message.includes('GS')) {
                        const today = new Date();
                        const dateStr = today.toISOString().slice(2,10).replace(/-/g, '');
                        const timeStr = today.toTimeString().slice(0,4).replace(':', '');
                        const gs = `GS*HC*SENDER12345*80882*${dateStr}*${timeStr}*1*X*005010X222A1~\n`;
                        const isaEnd = corrected.indexOf('~') + 2;
                        corrected = corrected.slice(0, isaEnd) + gs + corrected.slice(isaEnd);
                    } else if (error.message.includes('ST')) {
                        const st = 'ST*837*0001*005010X222A1~\n';
                        const gsEnd = corrected.lastIndexOf('GS') !== -1 ? 
                                     corrected.indexOf('~', corrected.lastIndexOf('GS')) + 2 : 
                                     corrected.indexOf('~') + 2;
                        corrected = corrected.slice(0, gsEnd) + st + corrected.slice(gsEnd);
                    }
                    break;
            }

            console.log('Correction applied. Data length before:', data.length, 'after:', corrected.length);
            return corrected;
        }

        function showFixSuccessMessage(errorType) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                background: linear-gradient(135deg, var(--success), #059669);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                font-weight: 600;
                animation: slideInRight 0.3s ease;
            `;
            
            toast.innerHTML = `
                <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Fix applied! ${errorType ? errorType + ' corrected.' : ''}
            `;
            
            document.body.appendChild(toast);
            
            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    document.body.removeChild(toast);
                    document.head.removeChild(style);
                }, 300);
            }, 3000);
        }

        function showMassCorrection() {
            document.getElementById('massCorrectionPanel').classList.add('active');
            buildMassCorrectionUI();
        }

        function hideMassCorrection() {
            document.getElementById('massCorrectionPanel').classList.remove('active');
        }

        function buildMassCorrectionUI() {
            const allIssues = [...validationResults.errors, ...validationResults.warnings];
            
            // Group errors by type
            const groupedErrors = {};
            allIssues.forEach(issue => {
                if (!groupedErrors[issue.type]) {
                    groupedErrors[issue.type] = [];
                }
                groupedErrors[issue.type].push(issue);
            });

            let html = '<div class="info-box">Configure how to automatically fix errors in bulk. Review each category and select the appropriate correction method.</div>';

            Object.keys(groupedErrors).forEach(errorType => {
                const errors = groupedErrors[errorType];
                html += `
                    <div class="correction-group">
                        <div class="correction-group-header">
                            <div class="correction-group-title">
                                <svg style="width: 24px; height: 24px; stroke: var(--error);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                ${errorType}
                                <span class="correction-count">${errors.length}</span>
                            </div>
                        </div>
                        <div class="correction-options">
                            ${getMassCorrectionOptions(errorType, errors[0])}
                        </div>
                    </div>
                `;
            });

            document.getElementById('massCorrectionContent').innerHTML = html;
        }

        function getMassCorrectionOptions(errorType, sampleError) {
            let options = '';

            switch (errorType) {
                case 'CODE_ERROR':
                    if (sampleError.location.includes('ISA')) {
                        options = `
                            <div class="correction-option">
                                <input type="radio" name="${errorType}" value="auto" checked>
                                <div class="correction-option-content">
                                    <label class="correction-option-label">Auto-correct to "00"</label>
                                    <div class="correction-option-desc">Replace all invalid authorization qualifiers with "00" (No Auth Info Present)</div>
                                </div>
                            </div>
                            <div class="correction-option">
                                <input type="radio" name="${errorType}" value="skip">
                                <div class="correction-option-content">
                                    <label class="correction-option-label">Skip corrections</label>
                                    <div class="correction-option-desc">Leave as-is and fix manually</div>
                                </div>
                            </div>
                        `;
                    } else if (sampleError.location.includes('HI')) {
                        options = `
                            <div class="correction-option">
                                <input type="radio" name="${errorType}" value="auto" checked>
                                <div class="correction-option-content">
                                    <label class="correction-option-label">Replace with default diagnosis code</label>
                                    <div class="correction-option-desc">Use Z9989 (Encounter for other specified special examinations)</div>
                                </div>
                            </div>
                            <div class="correction-option">
                                <input type="radio" name="${errorType}" value="remove">
                                <div class="correction-option-content">
                                    <label class="correction-option-label">Remove invalid codes</label>
                                    <div class="correction-option-desc">Delete segments with invalid diagnosis codes</div>
                                </div>
                            </div>
                            <div class="correction-option">
                                <input type="radio" name="${errorType}" value="skip">
                                <div class="correction-option-content">
                                    <label class="correction-option-label">Skip corrections</label>
                                    <div class="correction-option-desc">Leave as-is and fix manually</div>
                                </div>
                            </div>
                        `;
                    } else if (sampleError.location.includes('SV1')) {
                        options = `
                            <div class="correction-option">
                                <input type="radio" name="${errorType}" value="auto" checked>
                                <div class="correction-option-content">
                                    <label class="correction-option-label">Replace with default procedure code</label>
                                    <div class="correction-option-desc">Use 99213 (Office/outpatient visit, established patient)</div>
                                </div>
                            </div>
                            <div class="correction-option">
                                <input type="radio" name="${errorType}" value="skip">
                                <div class="correction-option-content">
                                    <label class="correction-option-label">Skip corrections</label>
                                    <div class="correction-option-desc">Leave as-is and fix manually</div>
                                </div>
                            </div>
                        `;
                    }
                    break;

                case 'DATE_ERROR':
                    options = `
                        <div class="correction-option">
                            <input type="radio" name="${errorType}" value="today" checked>
                            <div class="correction-option-content">
                                <label class="correction-option-label">Use today's date</label>
                                <div class="correction-option-desc">Replace all invalid dates with current date</div>
                            </div>
                        </div>
                        <div class="correction-option">
                            <input type="radio" name="${errorType}" value="first">
                            <div class="correction-option-content">
                                <label class="correction-option-label">Use first of current month</label>
                                <div class="correction-option-desc">Set date to first day of current month</div>
                            </div>
                        </div>
                        <div class="correction-option">
                            <input type="radio" name="${errorType}" value="skip">
                            <div class="correction-option-content">
                                <label class="correction-option-label">Skip corrections</label>
                                <div class="correction-option-desc">Leave as-is and fix manually</div>
                            </div>
                        </div>
                    `;
                    break;

                case 'AMOUNT_ERROR':
                    options = `
                        <div class="correction-option">
                            <input type="radio" name="${errorType}" value="default" checked>
                            <div class="correction-option-content">
                                <label class="correction-option-label">Use default amounts</label>
                                <div class="correction-option-desc">Claims: $100.00, Service Lines: $75.00</div>
                            </div>
                        </div>
                        <div class="correction-option">
                            <input type="radio" name="${errorType}" value="zero">
                            <div class="correction-option-content">
                                <label class="correction-option-label">Set to zero</label>
                                <div class="correction-option-desc">Replace with $0.01 (minimum valid amount)</div>
                            </div>
                        </div>
                        <div class="correction-option">
                            <input type="radio" name="${errorType}" value="skip">
                            <div class="correction-option-content">
                                <label class="correction-option-label">Skip corrections</label>
                                <div class="correction-option-desc">Leave as-is and fix manually</div>
                            </div>
                        </div>
                    `;
                    break;

                case 'VERSION_ERROR':
                    options = `
                        <div class="correction-option">
                            <input type="radio" name="${errorType}" value="auto" checked>
                            <div class="correction-option-content">
                                <label class="correction-option-label">Update to version 5010</label>
                                <div class="correction-option-desc">Set ISA12 to "00501"</div>
                            </div>
                        </div>
                        <div class="correction-option">
                            <input type="radio" name="${errorType}" value="skip">
                            <div class="correction-option-content">
                                <label class="correction-option-label">Skip corrections</label>
                                <div class="correction-option-desc">Leave as-is and fix manually</div>
                            </div>
                        </div>
                    `;
                    break;

                case 'CRITICAL':
                    options = `
                        <div class="correction-option">
                            <input type="radio" name="${errorType}" value="auto" checked>
                            <div class="correction-option-content">
                                <label class="correction-option-label">Add missing segments</label>
                                <div class="correction-option-desc">Insert required ISA/GS/ST segments with default values</div>
                            </div>
                        </div>
                        <div class="correction-option">
                            <input type="radio" name="${errorType}" value="skip">
                            <div class="correction-option-content">
                                <label class="correction-option-label">Skip corrections</label>
                                <div class="correction-option-desc">Leave as-is and fix manually</div>
                            </div>
                        </div>
                    `;
                    break;

                default:
                    options = `
                        <div class="correction-option">
                            <input type="radio" name="${errorType}" value="auto" checked>
                            <div class="correction-option-content">
                                <label class="correction-option-label">Auto-correct</label>
                                <div class="correction-option-desc">Apply recommended fixes automatically</div>
                            </div>
                        </div>
                        <div class="correction-option">
                            <input type="radio" name="${errorType}" value="skip">
                            <div class="correction-option-content">
                                <label class="correction-option-label">Skip corrections</label>
                                <div class="correction-option-desc">Leave as-is and fix manually</div>
                            </div>
                        </div>
                    `;
            }

            return options;
        }

        function applyMassCorrections() {
            const allIssues = [...validationResults.errors, ...validationResults.warnings];
            const groupedErrors = {};
            
            allIssues.forEach(issue => {
                if (!groupedErrors[issue.type]) {
                    groupedErrors[issue.type] = [];
                }
                groupedErrors[issue.type].push(issue);
            });

            // Store original data
            originalData = document.getElementById('validationInput').value;
            
            let workingData = originalData;
            let fixCount = 0;
            const fixedTypes = [];

            Object.keys(groupedErrors).forEach(errorType => {
                const selectedOption = document.querySelector(`input[name="${errorType}"]:checked`);
                if (selectedOption && selectedOption.value !== 'skip') {
                    groupedErrors[errorType].forEach(error => {
                        workingData = applyCorrection(workingData, error, selectedOption.value);
                        fixCount++;
                    });
                    fixedTypes.push(errorType);
                }
            });

            correctedData = workingData;
            
            // Update the input field with corrected data
            document.getElementById('validationInput').value = correctedData;

            // Show corrected data in both views
            document.getElementById('correctedDataPreview').textContent = correctedData;
            document.getElementById('afterCorrection').textContent = correctedData;
            document.getElementById('beforeCorrection').textContent = originalData;
            document.getElementById('correctedDataSection').classList.add('active');
            document.getElementById('massCorrectionPanel').classList.remove('active');

            // Show success summary
            showMassCorrectionSummary(fixCount, fixedTypes);
            
            // Auto re-validate after modal closes
            setTimeout(() => {
                validateCorrectedData();
            }, 2000);
        }

        function toggleComparisonView() {
            const isChecked = document.getElementById('comparisonToggle').checked;
            document.getElementById('singleView').style.display = isChecked ? 'none' : 'block';
            document.getElementById('comparisonView').style.display = isChecked ? 'block' : 'none';
        }

        function downloadCorrectedFile() {
            const validationType = document.getElementById('validationType').value;
            const blob = new Blob([correctedData], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `837_${validationType}_corrected_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function validateCorrectedData() {
            // Use the corrected data from the input field
            const dataToValidate = document.getElementById('validationInput').value;
            
            if (!dataToValidate) {
                alert('No data to validate');
                return;
            }

            // Reset state
            appliedFixes.clear();
            currentFilter = 'all';

            // Show loading state
            document.getElementById('validationResults').innerHTML = '<div class="loading"><div class="spinner"></div>Re-validating corrected data...</div>';
            
            // Scroll to validation results
            document.getElementById('validationOutput').scrollIntoView({ behavior: 'smooth', block: 'start' });

            setTimeout(() => {
                const validationType = document.getElementById('validationType').value;
                const results = performValidation(dataToValidate, validationType);
                validationResults = results;
                
                // Update the display with animation
                displayValidationResults(results);
                
                // Highlight the summary cards with animation
                setTimeout(() => {
                    const summaryCards = document.querySelectorAll('.summary-card');
                    summaryCards.forEach((card, index) => {
                        setTimeout(() => {
                            card.style.animation = 'pulse 0.5s ease';
                        }, index * 100);
                    });
                }, 300);
                
                // Show mass correction button if there are still errors
                if (results.errors.length > 0 || results.warnings.length > 0) {
                    document.getElementById('massFixButton').style.display = 'flex';
                    
                    // Show notification if errors remain
                    showRevalidationResult(results.errors.length, results.warnings.length);
                } else {
                    document.getElementById('massFixButton').style.display = 'none';
                    
                    // Show success notification
                    showValidationSuccess();
                }
                showDownloadBtn(results.errors.length, results.warnings.length);
            }, 1000);
        }

        function showRevalidationResult(errorCount, warningCount) {
            const toast = document.createElement('div');
            const hasErrors = errorCount > 0;
            const color = hasErrors ? 'var(--warning)' : 'var(--success)';
            const bgColor = hasErrors ? 'rgba(245, 158, 11, 0.4)' : 'rgba(16, 185, 129, 0.4)';
            
            toast.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                background: ${color};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: 0 8px 24px ${bgColor};
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                font-weight: 600;
                animation: slideInRight 0.3s ease;
            `;
            
            toast.innerHTML = `
                <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${hasErrors ? 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z' : 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'}"></path>
                </svg>
                ${hasErrors ? 
                    `Still ${errorCount} error${errorCount !== 1 ? 's' : ''} and ${warningCount} warning${warningCount !== 1 ? 's' : ''} remaining` : 
                    `Only ${warningCount} warning${warningCount !== 1 ? 's' : ''} remaining`
                }
            `;
            
            document.body.appendChild(toast);
            
            // Add pulse animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.05); }
                }
            `;
            document.head.appendChild(style);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                    if (document.head.contains(style)) {
                        document.head.removeChild(style);
                    }
                }, 300);
            }, 4000);
        }

        function showValidationSuccess() {
            // Create celebration modal
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-card);
                border: 2px solid var(--success);
                border-radius: 16px;
                padding: 3rem;
                max-width: 500px;
                box-shadow: 0 20px 60px rgba(16, 185, 129, 0.3);
                animation: slideUp 0.3s ease;
                text-align: center;
            `;
            
            modal.innerHTML = `
                <div style="width: 100px; height: 100px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, var(--success), #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: pulse 1s ease infinite;">
                    <svg style="width: 60px; height: 60px; stroke: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 style="font-size: 2rem; margin-bottom: 1rem; color: var(--success);">ðŸŽ‰ All Clear!</h3>
                <p style="color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 2rem;">
                    Your EDI data passed validation with no errors or warnings!
                </p>
                <button onclick="this.parentElement.parentElement.remove()" style="
                    background: linear-gradient(135deg, var(--success), #059669);
                    color: white;
                    border: none;
                    padding: 1rem 2.5rem;
                    border-radius: 8px;
                    font-weight: 700;
                    cursor: pointer;
                    font-size: 1.1rem;
                    font-family: 'Manrope', sans-serif;
                ">Awesome!</button>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Auto close after 5 seconds
            setTimeout(() => {
                if (document.body.contains(overlay)) {
                    overlay.remove();
                }
            }, 5000);
        }

        function forceClearErrors() {
            // Show confirmation dialog
            const confirmed = confirm('This will force clear all validation errors and mark the data as valid.\n\nThis is a one-time override and should only be used if you\'re certain the data is correct.\n\nContinue?');
            
            if (!confirmed) {
                return;
            }

            // Store the current data
            const currentData = document.getElementById('validationInput').value;
            const validationType = document.getElementById('validationType').value;

            // Count segments
            const segments = currentData.split('~').filter(s => s.trim());

            // Create clean validation results
            validationResults = {
                errors: [],
                warnings: [],
                totalSegments: segments.length
            };

            // Update display with success
            const summaryDiv = document.getElementById('validationSummary');
            const resultsDiv = document.getElementById('validationResults');

            // Display summary with all zeros
            summaryDiv.innerHTML = `
                <div class="summary-card success">
                    <div class="summary-value">0</div>
                    <div class="summary-label">Errors</div>
                </div>
                <div class="summary-card success">
                    <div class="summary-value">0</div>
                    <div class="summary-label">Warnings</div>
                </div>
                <div class="summary-card success">
                    <div class="summary-value">${segments.length}</div>
                    <div class="summary-label">Segments Checked</div>
                </div>
                <div class="summary-card success">
                    <div class="summary-value">âœ“</div>
                    <div class="summary-label">All Results</div>
                </div>
            `;

            // Display success message
            resultsDiv.innerHTML = `
                <div class="validation-item success">
                    <div class="validation-item-header">
                        <svg style="width: 24px; height: 24px; stroke: var(--success);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="validation-type">VALIDATION PASSED (FORCE CLEARED)</span>
                    </div>
                    <div class="validation-message">
                        All errors have been manually cleared. The EDI data is now marked as valid.
                    </div>
                    <div class="validation-recommendation">
                        <div class="recommendation-header">
                            <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Note
                        </div>
                        <div class="recommendation-content">
                            <strong>Force Clear Applied</strong>
                            <p style="margin-top: 0.5rem;">Errors were manually overridden. Ensure your EDI data meets all requirements before submission to production systems.</p>
                        </div>
                    </div>
                </div>
            `;

            // Hide error buttons
            document.getElementById('massFixButton').style.display = 'none';
            showDownloadBtn(0, 0);

            // Show success celebration
            showValidationSuccess();

            // Show force clear notification
            showForceClearNotification();
        }

        function showForceClearNotification() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                background: linear-gradient(135deg, var(--warning), #f59e0b);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: 0 8px 24px rgba(245, 158, 11, 0.4);
                z-index: 9999;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                font-weight: 600;
                animation: slideInRight 0.3s ease;
            `;
            
            toast.innerHTML = `
                <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                Validation errors force cleared - use with caution!
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        function showDebugInfo() {
            const data = document.getElementById('validationInput').value;
            const segments = data.split('~').filter(s => s.trim());
            
            // Find ISA, GS, ST segments
            const isaSegments = segments.filter(s => s.trim().startsWith('ISA'));
            const gsSegments = segments.filter(s => s.trim().startsWith('GS'));
            const stSegments = segments.filter(s => s.trim().startsWith('ST'));
            
            // Create modal with debug info
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
                overflow-y: auto;
                padding: 2rem;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-card);
                border: 2px solid var(--info);
                border-radius: 16px;
                padding: 2rem;
                max-width: 800px;
                width: 100%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(59, 130, 246, 0.3);
                animation: slideUp 0.3s ease;
            `;
            
            let debugHTML = `
                <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--info); display: flex; align-items: center; gap: 0.75rem;">
                    <svg style="width: 28px; height: 28px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Debug Information
                </h3>
                
                <div style="margin-bottom: 1.5rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem;">Total Segments: ${segments.length}</div>
                </div>

                <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem; color: ${isaSegments.length > 0 ? 'var(--success)' : 'var(--error)'};">
                        ISA Segments Found: ${isaSegments.length}
                    </div>
                    ${isaSegments.length > 0 ? `
                        <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; background: var(--bg-dark); padding: 0.75rem; border-radius: 6px; overflow-x: auto; color: var(--success);">
                            ${isaSegments[0].substring(0, 100)}${isaSegments[0].length > 100 ? '...' : ''}
                        </div>
                    ` : '<div style="color: var(--error);">âŒ No ISA segment detected</div>'}
                </div>

                <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem; color: ${gsSegments.length > 0 ? 'var(--success)' : 'var(--error)'};">
                        GS Segments Found: ${gsSegments.length}
                    </div>
                    ${gsSegments.length > 0 ? `
                        <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; background: var(--bg-dark); padding: 0.75rem; border-radius: 6px; overflow-x: auto; color: var(--success);">
                            ${gsSegments[0]}
                        </div>
                    ` : '<div style="color: var(--error);">âŒ No GS segment detected</div>'}
                </div>

                <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem; color: ${stSegments.length > 0 ? 'var(--success)' : 'var(--error)'};">
                        ST Segments Found: ${stSegments.length}
                    </div>
                    ${stSegments.length > 0 ? `
                        <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; background: var(--bg-dark); padding: 0.75rem; border-radius: 6px; overflow-x: auto; color: var(--success);">
                            ${stSegments[0]}
                        </div>
                    ` : '<div style="color: var(--error);">âŒ No ST segment detected</div>'}
                </div>

                <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px solid var(--info);">
                    <div style="font-weight: 700; margin-bottom: 0.5rem;">First 5 Segments:</div>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;">
                        ${segments.slice(0, 5).map((seg, idx) => `
                            <div style="padding: 0.25rem 0; border-bottom: 1px solid var(--border);">
                                <span style="color: var(--text-secondary);">${idx + 1}.</span> ${seg.substring(0, 80)}${seg.length > 80 ? '...' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>

                <button onclick="this.parentElement.parentElement.remove()" style="
                    background: linear-gradient(135deg, var(--info), #2563eb);
                    color: white;
                    border: none;
                    padding: 0.75rem 2rem;
                    border-radius: 8px;
                    font-weight: 700;
                    cursor: pointer;
                    font-family: 'Manrope', sans-serif;
                    width: 100%;
                ">Close</button>
            `;
            
            modal.innerHTML = debugHTML;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function showMassCorrectionSummary(fixCount, fixedTypes) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-card);
                border: 2px solid var(--success);
                border-radius: 16px;
                padding: 2rem;
                max-width: 500px;
                box-shadow: 0 20px 60px rgba(16, 185, 129, 0.3);
                animation: slideUp 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="text-align: center;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, var(--success), #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg style="width: 48px; height: 48px; stroke: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h3 style="font-size: 1.75rem; margin-bottom: 1rem; color: var(--success);">Corrections Applied!</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Successfully applied <strong style="color: var(--success); font-size: 1.5rem;">${fixCount}</strong> corrections
                    </p>
                    <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: left;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">Fixed Issues:</div>
                        ${fixedTypes.map(type => `
                            <div style="padding: 0.5rem; margin: 0.25rem 0; background: var(--bg-dark); border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 0.875rem;">
                                âœ“ ${type}
                            </div>
                        `).join('')}
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1.5rem;">
                        Re-validating automatically...
                    </p>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                        background: linear-gradient(135deg, var(--success), #059669);
                        color: white;
                        border: none;
                        padding: 0.75rem 2rem;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-family: 'Manrope', sans-serif;
                    ">Close</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Add animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // Auto close after 4 seconds
            setTimeout(() => {
                overlay.remove();
                style.remove();
            }, 4000);
        }

        function filterResults(filterType) {
            currentFilter = filterType;
            
            // Update active state on summary cards
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });
            
            applyCurrentFilter();
            
            // Update filter info
            const filterInfo = document.getElementById('filterInfo');
            const filterText = document.getElementById('filterText');
            
            if (filterType === 'all') {
                filterInfo.classList.remove('active');
                filterText.textContent = 'Showing all results';
            } else {
                filterInfo.classList.add('active');
                
                if (filterType === 'errors') {
                    filterText.textContent = `Showing only Errors (${validationResults.errors.length})`;
                } else if (filterType === 'warnings') {
                    filterText.textContent = `Showing only Warnings (${validationResults.warnings.length})`;
                } else if (filterType === 'segments') {
                    const segmentInfo = getSegmentBreakdown();
                    filterText.textContent = `Segment Details: ${segmentInfo}`;
                }
            }
        }

        function applyCurrentFilter() {
            const items = document.querySelectorAll('.validation-item');
            
            items.forEach(item => {
                const itemType = item.getAttribute('data-type');
                
                if (currentFilter === 'all') {
                    item.classList.remove('hidden');
                } else if (currentFilter === 'errors') {
                    if (itemType === 'error') {
                        item.classList.remove('hidden');
                    } else {
                        item.classList.add('hidden');
                    }
                } else if (currentFilter === 'warnings') {
                    if (itemType === 'warning') {
                        item.classList.remove('hidden');
                    } else {
                        item.classList.add('hidden');
                    }
                } else if (currentFilter === 'segments') {
                    // Show segment breakdown information
                    showSegmentBreakdown();
                }
            });
        }

        function clearFilter() {
            currentFilter = 'all';
            document.getElementById('filterInfo').classList.remove('active');
            applyCurrentFilter();
            
            // Remove active state from all cards
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Re-display results to update active states
            if (validationResults) {
                displayValidationResults(validationResults);
            }
        }

        function getSegmentBreakdown() {
            if (!validationResults) return '';
            
            const inputData = document.getElementById('validationInput').value;
            const segments = inputData.split('~').filter(s => s.trim());
            
            // Count segment types
            const segmentCounts = {};
            segments.forEach(seg => {
                const segType = seg.split('*')[0].trim();
                if (segType) {
                    segmentCounts[segType] = (segmentCounts[segType] || 0) + 1;
                }
            });
            
            const topSegments = Object.entries(segmentCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([type, count]) => `${type}(${count})`)
                .join(', ');
            
            return topSegments;
        }

        function showSegmentBreakdown() {
            const resultsDiv = document.getElementById('validationResults');
            const inputData = document.getElementById('validationInput').value;
            const segments = inputData.split('~').filter(s => s.trim());
            
            // Count all segment types
            const segmentCounts = {};
            segments.forEach(seg => {
                const segType = seg.split('*')[0].trim();
                if (segType) {
                    segmentCounts[segType] = (segmentCounts[segType] || 0) + 1;
                }
            });
            
            // Create breakdown display
            let html = `
                <div class="validation-item success">
                    <div class="validation-item-header">
                        <svg style="width: 24px; height: 24px; stroke: var(--success);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span class="validation-type">SEGMENT BREAKDOWN</span>
                    </div>
                    <div class="validation-message">
                        <strong>Total Segments Checked: ${validationResults.totalSegments}</strong>
                    </div>
                    <div class="validation-recommendation">
                        <div class="recommendation-header">
                            <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                            </svg>
                            Segment Types Found
                        </div>
                        <div class="recommendation-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                ${Object.entries(segmentCounts)
                                    .sort((a, b) => b[1] - a[1])
                                    .map(([type, count]) => `
                                        <div style="background: var(--bg-dark); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                                            <div style="font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--primary); font-size: 1.5rem;">${count}</div>
                                            <div style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem;">${type} Segment${count > 1 ? 's' : ''}</div>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        // ==========================================
        // VALIDATION FUNCTIONS
        // ==========================================

        function runValidation() {
            console.log('=== RUN VALIDATION CALLED ===');
            const input = document.getElementById('validateInput').value.trim();
            
            // Auto-detect format type from GS segment, default to professional
            let formatType = 'professional';
            const gsMatch = input.match(/GS\*HC\*[^*]*\*[^*]*\*[^*]*\*[^*]*\*[^*]*\*[^*]*\*([^~]*)/);
            if (gsMatch) {
                const version = gsMatch[1];
                if (version.includes('X222')) formatType = 'professional';
                else if (version.includes('X223')) formatType = 'institutional';
                else if (version.includes('X224')) formatType = 'dental';
            }
            
            console.log('Input length:', input.length);
            console.log('Format type (auto-detected):', formatType);

            if (!input) {
                showNotification('Please enter EDI data to validate', 'error');
                console.log('ERROR: No input data');
                return;
            }

            currentValidatedData = input;
            validationErrors = [];
            validationWarnings = [];
            
            console.log('Reset errors and warnings');

            // Parse segments
            const segments = input.split('~').filter(s => s.trim());

            // Run comprehensive validation
            validateStructure(segments, formatType);
            validateSegments(segments, formatType);

            // Display results
            displayValidationResults();
            
            // Update Error Dashboard with latest stats
            updateErrorDashboard();
        }

        function validateStructure(segments, formatType) {
            // Check ISA
            const isaSegment = segments.find(s => s.trim().startsWith('ISA*'));
            if (!isaSegment) {
                validationErrors.push({
                    severity: 'critical',
                    segment: 'ISA',
                    element: 'ISA',
                    message: 'Missing required ISA (Interchange Control Header) segment',
                    rule: 'ISA segment must be present at the start of the file',
                    fixable: true
                });
            } else {
                // Validate ISA elements
                const isaElements = isaSegment.split('*');
                
                // ISA01 - Authorization Qualifier
                if (isaElements[1] && !['00', '03'].includes(isaElements[1])) {
                    validationErrors.push({
                        severity: 'error',
                        segment: 'ISA',
                        element: 'ISA01',
                        message: `Invalid Authorization Information Qualifier: "${isaElements[1]}"`,
                        rule: 'ISA01 must be "00" or "03"',
                        fixable: true,
                        currentValue: isaElements[1],
                        suggestedValue: '00'
                    });
                }

                // ISA03 - Security Qualifier
                if (isaElements[3] && !['00', '01'].includes(isaElements[3])) {
                    validationErrors.push({
                        severity: 'error',
                        segment: 'ISA',
                        element: 'ISA03',
                        message: `Invalid Security Information Qualifier: "${isaElements[3]}"`,
                        rule: 'ISA03 must be "00" or "01"',
                        fixable: true,
                        currentValue: isaElements[3],
                        suggestedValue: '00'
                    });
                }

                // ISA12 - Version
                if (isaElements[12] && isaElements[12] !== '00501') {
                    validationErrors.push({
                        severity: 'error',
                        segment: 'ISA',
                        element: 'ISA12',
                        message: `Invalid version number: "${isaElements[12]}"`,
                        rule: 'ISA12 must be "00501" for 5010 version',
                        fixable: true,
                        currentValue: isaElements[12],
                        suggestedValue: '00501'
                    });
                }

                // ISA08 - Receiver ID
                const expectedReceiver = formatType === 'professional' ? '80882' :
                                        formatType === 'institutional' ? '80881' : '80880';
                if (isaElements[8] && !isaElements[8].trim().startsWith(expectedReceiver)) {
                    validationWarnings.push({
                        severity: 'warning',
                        segment: 'ISA',
                        element: 'ISA08',
                        message: `Receiver ID may be incorrect for ${formatType} format`,
                        rule: `Expected receiver ID: ${expectedReceiver}`,
                        fixable: true,
                        currentValue: isaElements[8].trim(),
                        suggestedValue: expectedReceiver.padEnd(15)
                    });
                }
            }

            // Check GS
            const gsSegment = segments.find(s => s.trim().startsWith('GS*'));
            if (!gsSegment) {
                validationErrors.push({
                    severity: 'critical',
                    segment: 'GS',
                    element: 'GS',
                    message: 'Missing required GS (Functional Group Header) segment',
                    rule: 'GS segment must appear between ISA and ST',
                    fixable: true
                });
            } else {
                const gsElements = gsSegment.split('*');
                
                // GS01 - Functional ID Code
                if (gsElements[1] && gsElements[1] !== 'HC') {
                    validationErrors.push({
                        severity: 'error',
                        segment: 'GS',
                        element: 'GS01',
                        message: `Invalid Functional Identifier Code: "${gsElements[1]}"`,
                        rule: 'GS01 must be "HC" for Health Care Claim (837)',
                        fixable: true,
                        currentValue: gsElements[1],
                        suggestedValue: 'HC'
                    });
                }

                // GS08 - Version
                const expectedVersion = formatType === 'professional' ? '005010X222A1' :
                                       formatType === 'institutional' ? '005010X223A2' : '005010X224A2';
                if (gsElements[8] && gsElements[8] !== expectedVersion) {
                    validationErrors.push({
                        severity: 'error',
                        segment: 'GS',
                        element: 'GS08',
                        message: `Invalid version identifier: "${gsElements[8]}"`,
                        rule: `GS08 must be "${expectedVersion}" for ${formatType}`,
                        fixable: true,
                        currentValue: gsElements[8],
                        suggestedValue: expectedVersion
                    });
                }
            }

            // Check ST
            const stSegments = segments.filter(s => s.trim().startsWith('ST*'));
            if (stSegments.length === 0) {
                validationErrors.push({
                    severity: 'critical',
                    segment: 'ST',
                    element: 'ST',
                    message: 'No ST (Transaction Set Header) segments found',
                    rule: 'At least one ST segment required for each transaction',
                    fixable: true
                });
            }
        }

        function validateSegments(segments, formatType) {
            let claimSegments = [];
            let serviceLineSegments = [];
            let inClaim = false;
            let inServiceLine = false;
            
            // Group segments by claim and service line
            segments.forEach((segment, idx) => {
                const trimmed = segment.trim();
                
                if (trimmed.startsWith('CLM*')) {
                    inClaim = true;
                    claimSegments.push({ startIdx: idx, segments: [], hasHI: false, hasDTP472: false });
                } else if (trimmed.startsWith('LX*')) {
                    inServiceLine = true;
                    serviceLineSegments.push({ startIdx: idx, segments: [], hasDTP472: false });
                }
                
                if (inClaim && claimSegments.length > 0) {
                    const currentClaim = claimSegments[claimSegments.length - 1];
                    currentClaim.segments.push({ idx, segment: trimmed });
                    
                    if (trimmed.startsWith('HI*')) {
                        currentClaim.hasHI = true;
                    }
                    if (trimmed.startsWith('DTP*472*')) {
                        currentClaim.hasDTP472 = true;
                    }
                    
                    // End of claim
                    if (trimmed.startsWith('SE*')) {
                        inClaim = false;
                    }
                }
                
                if (inServiceLine && serviceLineSegments.length > 0) {
                    const currentLine = serviceLineSegments[serviceLineSegments.length - 1];
                    currentLine.segments.push({ idx, segment: trimmed });
                    
                    if (trimmed.startsWith('DTP*472*')) {
                        currentLine.hasDTP472 = true;
                    }
                    
                    // End of service line (next LX or SE)
                    if (trimmed.startsWith('LX*') && currentLine.segments.length > 1) {
                        inServiceLine = false;
                    }
                    if (trimmed.startsWith('SE*')) {
                        inServiceLine = false;
                    }
                }
            });
            
            // Check for missing required segments (mapping errors)
            claimSegments.forEach((claim, claimIdx) => {
                if (!claim.hasHI) {
                    validationErrors.push({
                        severity: 'critical',
                        segment: 'HI',
                        element: 'HI',
                        message: `Missing required HI (Health Care Diagnosis Code) segment for claim ${claimIdx + 1}`,
                        rule: 'HI segment is required in loop 2300',
                        fixable: false,
                        segmentIndex: claim.startIdx
                    });
                }
                
                if (!claim.hasDTP472) {
                    validationErrors.push({
                        severity: 'error',
                        segment: 'DTP',
                        element: 'DTP*472',
                        message: `Missing required DTP*472 (Date-Service Date) segment for claim ${claimIdx + 1}`,
                        rule: 'DTP*472 segment is required in loop 2300 for service dates',
                        fixable: false,
                        segmentIndex: claim.startIdx
                    });
                }
            });
            
            // Check PRV segment presence
            const hasPRV = segments.some(s => s.trim().startsWith('PRV*'));
            if (!hasPRV) {
                validationErrors.push({
                    severity: 'warning',
                    segment: 'PRV',
                    element: 'PRV',
                    message: 'Missing PRV (Provider) segment in billing provider loop',
                    rule: 'PRV segment is situationally required when billing provider is rendering provider',
                    fixable: false
                });
            }
            
            // Check service line DTP segments
            serviceLineSegments.forEach((line, lineIdx) => {
                if (!line.hasDTP472) {
                    validationWarnings.push({
                        severity: 'warning',
                        segment: 'DTP',
                        element: 'DTP*472',
                        message: `Missing DTP*472 (Service Date) at service line ${lineIdx + 1}`,
                        rule: 'DTP*472 is recommended at service line level for date specificity',
                        fixable: false,
                        segmentIndex: line.startIdx
                    });
                }
            });
            
            // Continue with existing validation
            segments.forEach((segment, idx) => {
                const trimmed = segment.trim();
                
                // Validate HI segments (diagnosis codes)
                if (trimmed.startsWith('HI*')) {
                    const elements = segment.split('*');
                    elements.slice(1).forEach((elem, elemIdx) => {
                        if (elem) {
                            const parts = elem.split(':');
                            if (parts.length >= 2) {
                                const code = parts[1];
                                
                                // Check for obviously invalid codes
                                if (/^X+$/.test(code) || code === 'INVALID' || code.length < 3 || code.length > 7) {
                                    validationErrors.push({
                                        severity: 'error',
                                        segment: 'HI',
                                        element: `HI0${elemIdx + 1}`,
                                        message: `Invalid diagnosis code: "${code}"`,
                                        rule: 'ICD-10-CM codes must be 3-7 characters',
                                        fixable: true,
                                        currentValue: code,
                                        suggestedValue: 'R079',
                                        segmentIndex: idx
                                    });
                                }
                            }
                        }
                    });
                }

                // Validate SV1 segments (procedure codes)
                if (trimmed.startsWith('SV1*')) {
                    const elements = segment.split('*');
                    if (elements[1]) {
                        const parts = elements[1].split(':');
                        if (parts.length >= 2) {
                            const code = parts[1];
                            
                            // Check for invalid procedure codes
                            if (/^X+$/.test(code) || code === 'INVALID' || code.length < 4 || code.length > 7) {
                                validationErrors.push({
                                    severity: 'error',
                                    segment: 'SV1',
                                    element: 'SV101',
                                    message: `Invalid procedure code: "${code}"`,
                                    rule: 'CPT/HCPCS codes must be 4-7 characters',
                                    fixable: true,
                                    currentValue: code,
                                    suggestedValue: '99213',
                                    segmentIndex: idx
                                });
                            }
                        }

                        // Validate amount (SV102)
                        if (elements[2]) {
                            const amount = parseFloat(elements[2]);
                            if (isNaN(amount) || amount < 0) {
                                validationErrors.push({
                                    severity: 'error',
                                    segment: 'SV1',
                                    element: 'SV102',
                                    message: `Invalid line item charge amount: "${elements[2]}"`,
                                    rule: 'Amount must be a positive number',
                                    fixable: true,
                                    currentValue: elements[2],
                                    suggestedValue: '75.00',
                                    segmentIndex: idx
                                });
                            }
                        }
                    }
                }

                // Validate CLM segments
                if (trimmed.startsWith('CLM*')) {
                    const elements = segment.split('*');
                    if (elements[2]) {
                        const amount = parseFloat(elements[2]);
                        if (isNaN(amount) || amount <= 0) {
                            validationErrors.push({
                                severity: 'error',
                                segment: 'CLM',
                                element: 'CLM02',
                                message: `Invalid claim charge amount: "${elements[2]}"`,
                                rule: 'Claim amount must be greater than zero',
                                fixable: true,
                                currentValue: elements[2],
                                suggestedValue: '100.00',
                                segmentIndex: idx
                            });
                        }
                    }
                }

                // Validate DTP segments (dates)
                if (trimmed.startsWith('DTP*')) {
                    const elements = segment.split('*');
                    if (elements[3]) {
                        const date = elements[3];
                        const qualifier = elements[2];
                        
                        // Check date format based on qualifier
                        if (qualifier === 'D8') {
                            if (date.length !== 8 || !/^\d{8}$/.test(date)) {
                                validationErrors.push({
                                    severity: 'error',
                                    segment: 'DTP',
                                    element: 'DTP03',
                                    message: `Invalid date format: "${date}"`,
                                    rule: 'D8 qualifier requires CCYYMMDD format (8 digits)',
                                    fixable: true,
                                    currentValue: date,
                                    suggestedValue: new Date().toISOString().slice(0,10).replace(/-/g, ''),
                                    segmentIndex: idx
                                });
                            } else {
                                // Validate date components
                                const year = parseInt(date.substring(0, 4));
                                const month = parseInt(date.substring(4, 6));
                                const day = parseInt(date.substring(6, 8));
                                
                                if (month < 1 || month > 12 || day < 1 || day > 31) {
                                    validationErrors.push({
                                        severity: 'error',
                                        segment: 'DTP',
                                        element: 'DTP03',
                                        message: `Invalid date value: "${date}"`,
                                        rule: 'Month must be 01-12, day must be 01-31',
                                        fixable: true,
                                        currentValue: date,
                                        suggestedValue: new Date().toISOString().slice(0,10).replace(/-/g, ''),
                                        segmentIndex: idx
                                    });
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayValidationResults() {
            const summaryDiv = document.getElementById('validationSummaryCards');
            const resultsCard = document.getElementById('validationResultsCard');
            const errorsCard = document.getElementById('errorsListCard');
            const massFixButton = document.getElementById('massFixButtonGroup');

            resultsCard.style.display = 'block';
            errorsCard.style.display = 'block';

            const totalIssues = validationErrors.length + validationWarnings.length;
            const criticalCount = validationErrors.filter(e => e.severity === 'critical').length;
            const errorCount = validationErrors.filter(e => e.severity === 'error').length;
            const warningCount = validationWarnings.length;

            // Display summary cards
            summaryDiv.innerHTML = `
                <div class="summary-card ${totalIssues === 0 ? 'success' : 'error'}" style="flex: 1.5;">
                    <div class="summary-value">${totalIssues}</div>
                    <div class="summary-label">Total Issues</div>
                    ${totalIssues > 0 ? `<div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">${criticalCount + errorCount} must fix, ${warningCount} review</div>` : ''}
                </div>
                <div class="summary-card ${criticalCount > 0 ? 'error' : 'success'}">
                    <div class="summary-value">${criticalCount}</div>
                    <div class="summary-label">Critical</div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">ðŸš¨ Must Fix</div>
                </div>
                <div class="summary-card ${errorCount > 0 ? 'error' : 'success'}">
                    <div class="summary-value">${errorCount}</div>
                    <div class="summary-label">Errors</div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">âŒ Must Fix</div>
                </div>
                <div class="summary-card ${warningCount > 0 ? 'warning' : 'success'}">
                    <div class="summary-value">${warningCount}</div>
                    <div class="summary-label">Warnings</div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">âš ï¸ Review</div>
                </div>
            `;

            // Show mass fix button if there are fixable errors
            if (totalIssues > 0) {
                massFixButton.style.display = 'flex';
            } else {
                massFixButton.style.display = 'none';
            }
            showDownloadBtn(criticalCount + errorCount, warningCount);

            // Display individual errors
            console.log('Calling displayIndividualErrors...');
            displayIndividualErrors();
            
            console.log('=== RUN VALIDATION COMPLETE ===');
            console.log('Total errors:', validationErrors.length);
            console.log('Total warnings:', validationWarnings.length);
            console.log('Total issues:', totalIssues);
            
            // Log what the errors actually are
            if (validationErrors.length > 0) {
                console.log('\n=== REMAINING ERRORS DETAIL ===');
                validationErrors.forEach((error, idx) => {
                    console.log(`Error ${idx + 1}: [${error.severity}] ${error.segment}-${error.element}: ${error.message}`);
                    console.log(`  Fixable: ${error.fixable}, Segment Index: ${error.segmentIndex}`);
                });
            }
            
            // Show/hide Quick Fix HI button based on whether there are missing HI errors
            const quickFixButton = document.getElementById('quickFixHIButton');
            if (quickFixButton) {
                const hasMissingHI = validationErrors.some(e => 
                    e.segment === 'HI' && 
                    e.element === 'HI' && 
                    e.message.includes('Missing required HI')
                );
                quickFixButton.style.display = hasMissingHI ? 'block' : 'none';
            }
        }

        function displayIndividualErrors() {
            const errorsDiv = document.getElementById('errorsList');
            const allIssues = [...validationErrors, ...validationWarnings];
            
            // Get the filter value
            const filterSelect = document.getElementById('severityFilter');
            const filter = filterSelect ? filterSelect.value : 'all';

            // Apply filter
            let filteredIssues = allIssues;
            if (filter !== 'all') {
                filteredIssues = allIssues.filter(issue => {
                    if (filter === 'critical') {
                        return issue.severity === 'critical';
                    } else if (filter === 'error') {
                        return issue.severity === 'error';
                    } else if (filter === 'warning') {
                        return issue.severity === 'warning';
                    } else if (filter === 'fixable') {
                        return issue.fixable === true;
                    } else if (filter === 'unfixable') {
                        return issue.fixable === false;
                    }
                    return true;
                });
            }

            if (allIssues.length === 0) {
                errorsDiv.innerHTML = `
                    <div class="info-box" style="background: rgba(16, 185, 129, 0.1); border-color: var(--success);">
                        âœ… No validation errors found! The EDI data appears to be compliant with 837 v5010 specifications.
                    </div>
                `;
                return;
            }

            if (filteredIssues.length === 0 && filter !== 'all') {
                errorsDiv.innerHTML = `
                    <div class="info-box" style="background: rgba(59, 130, 246, 0.1); border-color: var(--info);">
                        â„¹ï¸ No ${filter} issues found. Showing 0 of ${allIssues.length} total issues.
                        <button onclick="document.getElementById('severityFilter').value='all'; filterErrors();" 
                                style="margin-left: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Show All
                        </button>
                    </div>
                `;
                return;
            }

            // Reset selected errors
            selectedErrorsToFix.clear();

            // Calculate counts for filter status
            const fixableInFilter = filteredIssues.filter(i => i.fixable).length;
            const unfixableInFilter = filteredIssues.filter(i => !i.fixable).length;
            const hasFixableErrors = fixableInFilter > 0;
            
            // Special handling for "All Issues" - show comprehensive fix options
            const isAllIssuesView = filter === 'all';

            // Show filter status if filtering OR if there are unfixable issues to fix
            let filterStatus = '';
            if (filter !== 'all' || (filter === 'all' && (unfixableInFilter > 0 || fixableInFilter > 0))) {
                
                // Determine filter display name
                let filterDisplayName = filter;
                if (filter === 'fixable') {
                    filterDisplayName = 'Data Fixes (Fixable)';
                } else if (filter === 'unfixable') {
                    filterDisplayName = 'Mapping Issues (Unfixable)';
                }
                
                // Only show "Fix All" button for fixable filters or severity filters with fixable items
                const showFixAllButton = (filter === 'fixable') || 
                                        (filter !== 'unfixable' && hasFixableErrors);
                
                // Show mapping assistant for unfixable issues OR if there are any unfixable issues in current filter
                const unfixableInFilter = filteredIssues.filter(i => !i.fixable).length;
                const showMappingAssistant = (filter === 'unfixable' && filteredIssues.length > 0) ||
                                            (unfixableInFilter > 0 && filter !== 'fixable');
                
                filterStatus = `
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid var(--info);">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
                            <span style="color: var(--info); font-weight: 600;">
                                ðŸ“‹ Showing ${filteredIssues.length} of ${allIssues.length} issues (${filterDisplayName})
                            </span>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                ${isAllIssuesView && (fixableInFilter > 0 || unfixableInFilter > 0) ? `
                                    ${fixableInFilter > 0 && unfixableInFilter > 0 ? `
                                        <button onclick="fixEverythingWorkflow()" style="
                                            padding: 0.75rem 1.5rem; 
                                            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                                            color: white; 
                                            border: none; 
                                            border-radius: 8px; 
                                            cursor: pointer; 
                                            font-weight: 800;
                                            display: flex;
                                            align-items: center;
                                            gap: 0.5rem;
                                            font-family: 'Manrope', sans-serif;
                                            transition: all 0.3s ease;
                                            font-size: 1.1rem;
                                            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
                                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(139, 92, 246, 0.5)';" 
                                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.3)';">
                                            <svg style="width: 22px; height: 22px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                            </svg>
                                            Fix Everything (${fixableInFilter + unfixableInFilter})
                                        </button>
                                    ` : ''}
                                    ${fixableInFilter > 0 ? `
                                        <button onclick="fixAllFiltered('fixable')" style="
                                            padding: 0.6rem 1.2rem; 
                                            background: linear-gradient(135deg, #10b981, #059669);
                                            color: white; 
                                            border: none; 
                                            border-radius: 8px; 
                                            cursor: pointer; 
                                            font-weight: 700;
                                            display: flex;
                                            align-items: center;
                                            gap: 0.5rem;
                                            font-family: 'Manrope', sans-serif;
                                            transition: all 0.3s ease;
                                            font-size: 1rem;
                                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.5)';" 
                                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                            <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            Fix All Data Issues (${fixableInFilter})
                                        </button>
                                    ` : ''}
                                    ${unfixableInFilter > 0 ? `
                                        <button onclick="openMappingAssistant()" style="
                                            padding: 0.6rem 1.2rem; 
                                            background: linear-gradient(135deg, #f59e0b, #d97706);
                                            color: white; 
                                            border: none; 
                                            border-radius: 8px; 
                                            cursor: pointer; 
                                            font-weight: 700;
                                            display: flex;
                                            align-items: center;
                                            gap: 0.5rem;
                                            font-family: 'Manrope', sans-serif;
                                            transition: all 0.3s ease;
                                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.4)';" 
                                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                            <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            Add Missing Segments (${unfixableInFilter})
                                        </button>
                                    ` : ''}
                                ` : ''}
                                ${!isAllIssuesView ? `
                                    ${showFixAllButton ? `
                                    <button id="fixSelectedBtn" onclick="fixSelectedErrors()" style="
                                        padding: 0.6rem 1.2rem; 
                                        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                                        color: white; 
                                        border: none; 
                                        border-radius: 8px; 
                                        cursor: pointer; 
                                        font-weight: 700;
                                        display: none;
                                        align-items: center;
                                        gap: 0.5rem;
                                        font-family: 'Manrope', sans-serif;
                                        transition: all 0.3s ease;
                                        opacity: 0.5;
                                    " onmouseover="if(!this.disabled) { this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.4)'; }" 
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                        <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                        <span id="fixSelectedBtnText">Fix Selected</span>
                                    </button>
                                    <button onclick="fixAllFiltered('${filter}')" style="
                                        padding: 0.6rem 1.2rem; 
                                        background: linear-gradient(135deg, var(--success), #059669); 
                                        color: white; 
                                        border: none; 
                                        border-radius: 8px; 
                                        cursor: pointer; 
                                        font-weight: 700;
                                        display: flex;
                                        align-items: center;
                                        gap: 0.5rem;
                                        font-family: 'Manrope', sans-serif;
                                        transition: all 0.3s ease;
                                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.4)';" 
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                        <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Fix All ${filter === 'fixable' ? 'Data Fixes' : filter.charAt(0).toUpperCase() + filter.slice(1)} (${fixableInFilter})
                                    </button>
                                ` : ''}
                                ${showMappingAssistant ? `
                                    <button onclick="openMappingAssistant()" style="
                                        padding: 0.6rem 1.2rem; 
                                        background: linear-gradient(135deg, #f59e0b, #d97706);
                                        color: white; 
                                        border: none; 
                                        border-radius: 8px; 
                                        cursor: pointer; 
                                        font-weight: 700;
                                        display: flex;
                                        align-items: center;
                                        gap: 0.5rem;
                                        font-family: 'Manrope', sans-serif;
                                        transition: all 0.3s ease;
                                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.4)';" 
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                        <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Add Missing Segments (${unfixableInFilter})
                                    </button>
                                ` : ''}
                                ${filter === 'unfixable' ? `
                                    <div style="
                                        padding: 0.6rem 1.2rem; 
                                        background: rgba(239, 68, 68, 0.1);
                                        color: var(--error);
                                        border: 2px solid var(--error);
                                        border-radius: 8px;
                                        font-weight: 700;
                                        display: flex;
                                        align-items: center;
                                        gap: 0.5rem;
                                        font-family: 'Manrope', sans-serif;
                                    ">
                                        <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        Manual Review Required
                                    </div>
                                ` : ''}
                                ` : ''}
                                <button onclick="document.getElementById('severityFilter').value='all'; filterErrors();" 
                                        style="padding: 0.6rem 1.2rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Clear Filter
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            let html = filterStatus;

            filteredIssues.forEach((issue, displayIdx) => {
                // Find the original index in allIssues
                const originalIdx = allIssues.indexOf(issue);
                
                const severityClass = issue.severity === 'critical' ? 'error' : issue.severity;
                const severityIcon = issue.severity === 'critical' ? 'ðŸš¨' : issue.severity === 'error' ? 'âŒ' : 'âš ï¸';
                
                // Check if this error was fixed
                const fixInfo = wasFixed(issue);
                
                html += `
                    <div class="error-card" style="border-color: var(--${severityClass}); margin-bottom: 1.5rem; ${fixInfo ? 'background: linear-gradient(to right, rgba(16, 185, 129, 0.05), var(--bg-card)); border-left: 4px solid var(--success);' : ''}" id="error-card-${originalIdx}">
                        <div class="error-card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                ${issue.fixable && !fixInfo ? `
                                    <input type="checkbox" class="error-checkbox" data-index="${originalIdx}" 
                                           onchange="updateSelectedErrors()"
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: #8b5cf6;">
                                ` : fixInfo ? `
                                    <span style="color: var(--success); font-size: 1.2rem;">âœ“</span>
                                ` : ''}
                                <span>${severityIcon} ${issue.segment} - ${issue.element}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${fixInfo ? `<span style="background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 700;">FIXED</span>` : ''}
                                <span class="error-card-tag" style="background: var(--${severityClass});">${issue.severity.toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="error-card-body" style="margin-left: ${issue.fixable && !fixInfo ? '2.5rem' : fixInfo ? '2rem' : '0'};">
                            <strong>Issue:</strong> ${issue.message}<br>
                            <strong>Rule:</strong> ${issue.rule}<br>
                            ${issue.currentValue ? `<strong>Current Value:</strong> <code style="color: var(--error);">${issue.currentValue}</code><br>` : ''}
                            ${issue.suggestedValue ? `<strong>Suggested Value:</strong> <code style="color: var(--success);">${issue.suggestedValue}</code><br>` : ''}
                            ${fixInfo ? `
                                <div style="margin-top: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid var(--success);">
                                    <div style="font-weight: 700; color: var(--success); margin-bottom: 0.5rem;">âœ“ Fix Applied</div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                        <strong>Time:</strong> ${fixInfo.timestamp}<br>
                                        <strong>Method:</strong> ${
                                            fixInfo.method === 'individual' ? 'ðŸ”§ Individual Fix' :
                                            fixInfo.method === 'mass-fix' ? 'âš¡ Mass Fix' :
                                            fixInfo.method === 'mapping' ? 'ðŸ“‹ Mapping Assistant' :
                                            fixInfo.method === 'quick-fix' ? 'ðŸš€ Quick Fix' : fixInfo.method
                                        }<br>
                                        ${fixInfo.details ? `<strong>Change:</strong> ${fixInfo.details}` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        ${issue.fixable && !fixInfo ? `
                            <div style="margin-top: 1rem; margin-left: 2.5rem;">
                                <button class="btn-fix" onclick="applyIndividualFix(${originalIdx})" id="fix-btn-${originalIdx}">
                                    <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    Apply Fix
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            errorsDiv.innerHTML = html;
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllErrors');
            const checkboxes = document.querySelectorAll('.error-checkbox');
            
            // Clear all selections first
            selectedErrorsToFix.clear();
            
            // If checking "select all", add only the visible (filtered) checkboxes
            if (selectAllCheckbox.checked) {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    const idx = parseInt(checkbox.dataset.index);
                    selectedErrorsToFix.add(idx);
                });
            } else {
                // Uncheck all visible checkboxes
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }

            updateMassFixButton();
            updateQuickFixButton();
        }

        function toggleErrorSelection(idx) {
            const checkbox = document.querySelector(`.error-checkbox[data-index="${idx}"]`);
            if (checkbox.checked) {
                selectedErrorsToFix.add(idx);
            } else {
                selectedErrorsToFix.delete(idx);
            }

            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById('selectAllErrors');
            const allCheckboxes = document.querySelectorAll('.error-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.error-checkbox:checked');
            
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
            }

            updateMassFixButton();
            updateQuickFixButton();
        }

        function updateQuickFixButton() {
            const quickFixBtn = document.getElementById('quickFixButton');
            const quickFixText = document.getElementById('quickFixButtonText');
            const selectionCounter = document.getElementById('selectionCounter');
            
            if (quickFixBtn && quickFixText) {
                if (selectedErrorsToFix.size > 0) {
                    quickFixText.textContent = `Fix Selected (${selectedErrorsToFix.size})`;
                    quickFixBtn.style.opacity = '1';
                    quickFixBtn.style.cursor = 'pointer';
                    quickFixBtn.disabled = false;
                    
                    // Show and update selection counter badge
                    if (selectionCounter) {
                        selectionCounter.style.display = 'inline-block';
                        selectionCounter.textContent = `${selectedErrorsToFix.size} selected`;
                    }
                } else {
                    quickFixText.textContent = 'Fix Selected Errors';
                    quickFixBtn.style.opacity = '0.5';
                    quickFixBtn.style.cursor = 'not-allowed';
                    quickFixBtn.disabled = true;
                    
                    // Hide selection counter badge
                    if (selectionCounter) {
                        selectionCounter.style.display = 'none';
                    }
                }
            }
        }

        function quickFixSelected() {
            const allIssues = [...validationErrors, ...validationWarnings];
            
            console.log('=== QUICK FIX SELECTED ===');
            console.log('Selected error indices:', Array.from(selectedErrorsToFix));
            console.log('Total issues:', allIssues.length);
            
            if (selectedErrorsToFix.size === 0) {
                showNotification('Please select at least one error to fix by checking the checkboxes.', 'error');
                return;
            }
            
            // Get selected issues
            const issuesToFix = Array.from(selectedErrorsToFix)
                .map(idx => {
                    const issue = allIssues[idx];
                    console.log(`  Index ${idx}:`, issue ? `${issue.segment}-${issue.element} (fixable: ${issue.fixable})` : 'undefined');
                    return issue;
                })
                .filter(i => i && i.fixable);
            
            console.log('Fixable issues from selection:', issuesToFix.length);
            
            if (issuesToFix.length === 0) {
                showNotification('None of the selected errors are fixable automatically. They may require manual correction.', 'error');
                return;
            }
            
            // Proceed without confirmation (sandboxed iframe blocks confirm())
            showNotification(`Fixing ${issuesToFix.length} selected errors...`, 'info');
            
            console.log('Calling applyMassValidationFixes()');
            
            // Use the same mass fix logic
            applyMassValidationFixes();
        }

        function updateMassFixButton() {
            const massFixBtn = document.querySelector('button[onclick="applyMassValidationFixes()"]');
            if (massFixBtn) {
                if (selectedErrorsToFix.size > 0) {
                    massFixBtn.innerHTML = `
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Fix Selected (${selectedErrorsToFix.size})
                    `;
                } else {
                    massFixBtn.innerHTML = `
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Mass Fix All Errors
                    `;
                }
            }
        }

        function applyIndividualFix(issueIndex) {
            console.log('=== INDIVIDUAL FIX ===');
            console.log('Issue Index:', issueIndex);
            
            const allIssues = [...validationErrors, ...validationWarnings];
            console.log('Total issues:', allIssues.length);
            
            const issue = allIssues[issueIndex];
            console.log('Issue to fix:', issue);

            if (!issue) {
                console.error('Issue not found at index:', issueIndex);
                showNotification('Error: Could not find the issue to fix. Please try re-running validation.', 'error');
                return;
            }

            if (!issue.fixable) {
                console.error('Issue is not fixable:', issue);
                showNotification('This issue cannot be fixed automatically. It may require manual correction.', 'error');
                return;
            }

            console.log('Applying fix...');
            console.log('Current data length:', currentValidatedData.length);

            try {
                // Apply the fix to the data
                let segments = currentValidatedData.split('~').filter(s => s.trim());
                console.log('Total segments:', segments.length);
                console.log('Issue segment index:', issue.segmentIndex);
                
                if (issue.segmentIndex !== undefined && issue.segmentIndex >= 0 && issue.segmentIndex < segments.length) {
                    // Fix specific segment
                    let segment = segments[issue.segmentIndex];
                    console.log('Original segment:', segment);
                    
                    const elements = segment.split('*');
                    console.log('Elements:', elements);
                    
                    if (issue.segment === 'HI') {
                        // Fix diagnosis code
                        const elemMatch = issue.element.match(/HI0(\d+)/);
                        if (elemMatch) {
                            const elemIdx = parseInt(elemMatch[1]);
                            if (elements[elemIdx]) {
                                const parts = elements[elemIdx].split(':');
                                console.log('Old diagnosis code:', parts[1]);
                                parts[1] = issue.suggestedValue;
                                console.log('New diagnosis code:', parts[1]);
                                elements[elemIdx] = parts.join(':');
                            }
                        }
                    } else if (issue.segment === 'SV1') {
                        if (issue.element === 'SV101') {
                            const parts = elements[1].split(':');
                            console.log('Old procedure code:', parts[1]);
                            parts[1] = issue.suggestedValue;
                            console.log('New procedure code:', parts[1]);
                            elements[1] = parts.join(':');
                        } else if (issue.element === 'SV102') {
                            console.log('Old amount:', elements[2]);
                            elements[2] = issue.suggestedValue;
                            console.log('New amount:', elements[2]);
                        }
                    } else if (issue.segment === 'CLM') {
                        if (issue.element === 'CLM02') {
                            console.log('Old claim amount:', elements[2]);
                            elements[2] = issue.suggestedValue;
                            console.log('New claim amount:', elements[2]);
                        }
                    } else if (issue.segment === 'DTP') {
                        if (issue.element === 'DTP03') {
                            console.log('Old date:', elements[3]);
                            elements[3] = issue.suggestedValue;
                            console.log('New date:', elements[3]);
                        }
                    }
                    
                    segments[issue.segmentIndex] = elements.join('*');
                    console.log('Modified segment:', segments[issue.segmentIndex]);
                } else {
                    // Fix ISA/GS level issues
                    console.log('Fixing ISA/GS level issue');
                    for (let i = 0; i < segments.length; i++) {
                        if (segments[i].trim().startsWith(issue.segment + '*')) {
                            console.log('Found segment at index', i);
                            const elements = segments[i].split('*');
                            const elemMatch = issue.element.match(/\d+$/);
                            
                            if (elemMatch) {
                                const elemNum = parseInt(elemMatch[0]);
                                console.log('Element number:', elemNum);
                                
                                if (elements[elemNum]) {
                                    console.log('Old value:', elements[elemNum]);
                                    elements[elemNum] = issue.suggestedValue;
                                    console.log('New value:', elements[elemNum]);
                                    segments[i] = elements.join('*');
                                }
                            }
                            break;
                        }
                    }
                }

                currentValidatedData = segments.join('~');
                document.getElementById('validateInput').value = currentValidatedData;
                
                // Record the fix
                const fixDetails = issue.currentValue && issue.suggestedValue ? 
                    `Changed from "${issue.currentValue}" to "${issue.suggestedValue}"` :
                    `Applied suggested fix`;
                recordFix(issue, 'individual', fixDetails);
                
                console.log('âœ“ Fix applied successfully');
                console.log('New data length:', currentValidatedData.length);

                // Update button
                const button = document.getElementById(`fix-btn-${issueIndex}`);
                if (button) {
                    button.innerHTML = `
                        <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Applied âœ“
                    `;
                    button.classList.add('applied');
                    button.disabled = true;
                    button.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
                    button.style.cursor = 'not-allowed';
                }

                // Show notification
                showNotification(`âœ“ Fixed ${issue.segment}-${issue.element}`, 'success');
                
            } catch (error) {
                console.error('Error applying fix:', error);
                showNotification('Error applying fix: ' + error.message, 'error');
            }
        }

        function applyMassValidationFixes() {
            const allIssues = [...validationErrors, ...validationWarnings];
            
            console.log('=== MASS FIX DEBUG START ===');
            console.log('Total errors:', validationErrors.length);
            console.log('Total warnings:', validationWarnings.length);
            console.log('Selected indices:', Array.from(selectedErrorsToFix));
            
            // Get issues to fix
            let issuesToFix = [];
            if (selectedErrorsToFix.size > 0) {
                issuesToFix = Array.from(selectedErrorsToFix).map(idx => allIssues[idx]).filter(i => i && i.fixable);
            } else {
                issuesToFix = allIssues.filter(i => i.fixable);
            }

            console.log('Issues to fix:', issuesToFix.length);

            if (issuesToFix.length === 0) {
                showNotification('No fixable issues selected.', 'error');
                return;
            }

            // Proceed without confirmation (sandboxed iframe blocks confirm())
            showNotification(`Applying ${issuesToFix.length} fixes...`, 'info');

            const massFixBtn = document.querySelector('button[onclick="applyMassValidationFixes()"]');
            if (massFixBtn) {
                massFixBtn.disabled = true;
                massFixBtn.textContent = `Applying ${issuesToFix.length} fixes...`;
            }

            showNotification(`Applying ${issuesToFix.length} fixes...`, 'info');

            // Create visible progress indicator
            const progressDiv = document.createElement('div');
            progressDiv.id = 'fix-progress';
            progressDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-card);
                padding: 2rem;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                z-index: 9999;
                min-width: 400px;
                border: 2px solid var(--primary);
            `;
            progressDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--primary);">
                        Applying Fixes...
                    </div>
                    <div style="font-size: 1.2rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        <span id="progress-count">0</span> / ${issuesToFix.length}
                    </div>
                </div>
                <div style="background: var(--bg-input); height: 30px; border-radius: 15px; overflow: hidden;">
                    <div id="progress-bar" style="background: linear-gradient(135deg, var(--success), #059669); 
                         height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="progress-status" style="margin-top: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                    Starting...
                </div>
            `;
            document.body.appendChild(progressDiv);

            let segments = currentValidatedData.split('~').filter(s => s.trim());
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸ”§ MASS FIX STARTED');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸ“Š Total segments in file:', segments.length);
            console.log('ðŸŽ¯ Issues to fix:', issuesToFix.length);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
            
            let fixCount = 0;

            issuesToFix.forEach((issue, idx) => {
                // Update progress bar
                const progressBar = document.getElementById('progress-bar');
                const progressCount = document.getElementById('progress-count');
                const progressStatus = document.getElementById('progress-status');
                
                if (progressBar && progressCount && progressStatus) {
                    const percent = Math.round(((idx + 1) / issuesToFix.length) * 100);
                    progressBar.style.width = percent + '%';
                    progressCount.textContent = idx + 1;
                    progressStatus.textContent = `Fixing ${issue.segment}-${issue.element}...`;
                }

                console.log(`\n[${ idx + 1}/${issuesToFix.length}] Attempting to fix: ${issue.segment}-${issue.element}`);
                console.log('   ðŸ“ Segment Index:', issue.segmentIndex !== undefined ? issue.segmentIndex : 'NOT SET');
                console.log('   ðŸ’¡ Suggested Value:', issue.suggestedValue);
                console.log('   ðŸ” Current Value:', issue.currentValue || 'N/A');
                
                try {
                    let fixed = false;

                    if (issue.segmentIndex !== undefined && issue.segmentIndex >= 0) {
                        const segment = segments[issue.segmentIndex];
                        if (!segment) {
                            console.log('   âŒ FAILED: Segment not found at index', issue.segmentIndex);
                            return;
                        }
                        
                        console.log('   ðŸ“„ Original:', segment.substring(0, 80) + '...');
                        const elements = segment.split('*');
                        console.log('   ðŸ”¢ Elements in segment:', elements.length);
                        
                        if (issue.segment === 'HI') {
                            const match = issue.element.match(/HI0(\d+)/);
                            if (match) {
                                const elemIdx = parseInt(match[1]);
                                console.log('   ðŸŽ¯ Targeting HI element at position:', elemIdx);
                                if (elements[elemIdx]) {
                                    const parts = elements[elemIdx].split(':');
                                    if (parts.length >= 2) {
                                        console.log('   ðŸ”„ Changing:', parts[1], 'â†’', issue.suggestedValue);
                                        parts[1] = issue.suggestedValue;
                                        elements[elemIdx] = parts.join(':');
                                        segments[issue.segmentIndex] = elements.join('*');
                                        fixed = true;
                                    }
                                }
                            }
                        } else if (issue.segment === 'SV1') {
                            if (issue.element === 'SV101') {
                                const parts = elements[1].split(':');
                                if (parts.length >= 2) {
                                    console.log('   ðŸ”„ Changing:', parts[1], 'â†’', issue.suggestedValue);
                                    parts[1] = issue.suggestedValue;
                                    elements[1] = parts.join(':');
                                    segments[issue.segmentIndex] = elements.join('*');
                                    fixed = true;
                                }
                            } else if (issue.element === 'SV102') {
                                console.log('   ðŸ”„ Changing:', elements[2], 'â†’', issue.suggestedValue);
                                elements[2] = issue.suggestedValue;
                                segments[issue.segmentIndex] = elements.join('*');
                                fixed = true;
                            }
                        } else if (issue.segment === 'CLM') {
                            console.log('   ðŸ”„ Changing:', elements[2], 'â†’', issue.suggestedValue);
                            elements[2] = issue.suggestedValue;
                            segments[issue.segmentIndex] = elements.join('*');
                            fixed = true;
                        } else if (issue.segment === 'DTP') {
                            console.log('   ðŸ”„ Changing:', elements[3], 'â†’', issue.suggestedValue);
                            elements[3] = issue.suggestedValue;
                            segments[issue.segmentIndex] = elements.join('*');
                            fixed = true;
                        }
                        
                        if (fixed) {
                            console.log('   âœ… SUCCESS! Modified:', segments[issue.segmentIndex].substring(0, 80) + '...');
                        }
                    } else {
                        console.log('   ðŸ” Searching for', issue.segment, 'segment in file...');
                        // ISA/GS level
                        for (let i = 0; i < segments.length; i++) {
                            if (segments[i].trim().startsWith(issue.segment + '*')) {
                                console.log('   ðŸ“ Found at segment index:', i);
                                const elements = segments[i].split('*');
                                const match = issue.element.match(/\d+$/);
                                if (match) {
                                    const elemNum = parseInt(match[0]);
                                    console.log('   ðŸŽ¯ Targeting element position:', elemNum);
                                    if (elements[elemNum]) {
                                        console.log('   ðŸ”„ Changing:', elements[elemNum], 'â†’', issue.suggestedValue);
                                        elements[elemNum] = issue.suggestedValue;
                                        segments[i] = elements.join('*');
                                        fixed = true;
                                        break;
                                    }
                                }
                            }
                        }
                    }

                    if (fixed) {
                        fixCount++;
                        console.log('   âœ… FIX APPLIED SUCCESSFULLY (#' + fixCount + ')');
                    } else {
                        console.log('   âŒ FIX FAILED - Could not apply');
                    }
                } catch (error) {
                    console.log('   âŒ EXCEPTION:', error.message);
                    console.error(error);
                }
                console.log('   ' + 'â”€'.repeat(50));
            });

            // Remove progress indicator
            const progressElement = document.getElementById('fix-progress');
            if (progressElement) {
                progressElement.remove();
            }

            const newData = segments.join('~');
            currentValidatedData = newData;
            document.getElementById('validateInput').value = newData;

            console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸ“Š MASS FIX RESULTS');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('âœ… Successfully Fixed:', fixCount);
            console.log('âŒ Failed to Fix:', issuesToFix.length - fixCount);
            console.log('ðŸ“ˆ Success Rate:', Math.round((fixCount / issuesToFix.length) * 100) + '%');
            console.log('ðŸ’¾ Data Updated:', currentValidatedData.length, 'characters');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
            
            selectedErrorsToFix.clear();

            // Show large visual success modal
            const resultModal = document.createElement('div');
            resultModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            const successRate = Math.round((fixCount / issuesToFix.length) * 100);
            const iconColor = fixCount === issuesToFix.length ? 'var(--success)' : 
                             fixCount > 0 ? 'var(--warning)' : 'var(--error)';
            const icon = fixCount === issuesToFix.length ? 'âœ…' : 
                        fixCount > 0 ? 'âš ï¸' : 'âŒ';
            
            resultModal.innerHTML = `
                <div style="background: var(--bg-card); border: 3px solid ${iconColor}; border-radius: 20px; 
                            padding: 3rem; max-width: 600px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); text-align: center;">
                    <div style="font-size: 5rem; margin-bottom: 1rem;">${icon}</div>
                    <h2 style="font-size: 2.5rem; margin-bottom: 1rem; color: ${iconColor};">
                        ${fixCount === issuesToFix.length ? 'All Fixes Applied!' : 
                          fixCount > 0 ? 'Partial Success' : 'Fixes Failed'}
                    </h2>
                    <div style="font-size: 3rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; 
                                color: ${iconColor}; margin: 1.5rem 0;">
                        ${fixCount} / ${issuesToFix.length}
                    </div>
                    <div style="font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 2rem;">
                        ${successRate}% Success Rate
                    </div>
                    <div style="background: var(--bg-input); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                        <div style="font-weight: 600; margin-bottom: 1rem;">What's Next:</div>
                        <div style="text-align: left; color: var(--text-secondary);">
                            ${fixCount > 0 ? 'âœ“ Data has been updated with fixes<br>' : ''}
                            ${fixCount > 0 ? 'âœ“ Re-validation will run automatically<br>' : ''}
                            ${fixCount < issuesToFix.length ? 'âš ï¸ Some fixes could not be applied<br>' : ''}
                            ${fixCount < issuesToFix.length ? 'âš ï¸ Check console (F12) for details' : ''}
                            ${fixCount === 0 ? 'âŒ No changes were made to the data<br>' : ''}
                            ${fixCount === 0 ? 'âŒ Open console (F12) to see why fixes failed' : ''}
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: linear-gradient(135deg, ${iconColor}, ${iconColor});
                        color: white;
                        border: none;
                        padding: 1rem 3rem;
                        border-radius: 12px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 1.2rem;
                        font-family: 'Manrope', sans-serif;
                        filter: brightness(1.1);
                    ">Continue</button>
                </div>
            `;
            
            document.body.appendChild(resultModal);
            
            showNotification(`Applied ${fixCount} of ${issuesToFix.length} fixes!`, fixCount > 0 ? 'success' : 'error');

            if (massFixBtn) {
                massFixBtn.disabled = false;
                massFixBtn.textContent = 'Mass Fix All Errors';
            }

            setTimeout(() => {
                console.log('Re-validating...');
                runValidation();
                console.log('=== MASS FIX DEBUG END ===');
            }, 1500);
        }

        function exportValidationReport() {
            const allIssues = [...validationErrors, ...validationWarnings];
            
            let report = '837 EDI VALIDATION REPORT\n';
            report += '='.repeat(80) + '\n\n';
            report += `Generated: ${new Date().toLocaleString()}\n`;
            report += `Total Issues: ${allIssues.length}\n`;
            report += `Critical: ${validationErrors.filter(e => e.severity === 'critical').length}\n`;
            report += `Errors: ${validationErrors.filter(e => e.severity === 'error').length}\n`;
            report += `Warnings: ${validationWarnings.length}\n\n`;
            report += '='.repeat(80) + '\n\n';

            allIssues.forEach((issue, idx) => {
                report += `${idx + 1}. [${issue.severity.toUpperCase()}] ${issue.segment} - ${issue.element}\n`;
                report += `   Issue: ${issue.message}\n`;
                report += `   Rule: ${issue.rule}\n`;
                if (issue.currentValue) report += `   Current: ${issue.currentValue}\n`;
                if (issue.suggestedValue) report += `   Suggested: ${issue.suggestedValue}\n`;
                report += '\n';
            });

            // Download report
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `validation_report_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function clearValidationInput() {
            document.getElementById('validateInput').value = '';
            document.getElementById('validationResultsCard').style.display = 'none';
            document.getElementById('errorsListCard').style.display = 'none';
            validationErrors = [];
            validationWarnings = [];
        }

        function useGeneratedData() {
            if (!generatedData) {
                alert('No generated data available. Please generate data first in the Generate tab.');
                return;
            }
            document.getElementById('validateInput').value = generatedData;
            showNotification('Generated data loaded into validator', 'success');
        }

        function filterErrors() {
            const filter = document.getElementById('severityFilter').value;
            displayIndividualErrors(); // Re-display with filter applied
        }
        
        // Inspect EDI data structure
        function inspectEDIStructure() {
            console.log('\n=== INSPECT EDI DATA ===');
            const data = document.getElementById('validateInput').value;
            const segments = data.split('~').filter(s => s.trim());
            
            console.log('Total segments:', segments.length);
            console.log('Data length:', data.length);
            
            // Find all CLM segments and what comes after
            console.log('\n=== CLAIM STRUCTURE ===');
            let claimCount = 0;
            for (let i = 0; i < segments.length; i++) {
                const seg = segments[i].trim();
                
                if (seg.startsWith('CLM*')) {
                    claimCount++;
                    console.log(`\nClaim ${claimCount} at index ${i}:`);
                    console.log(`  ${i}: ${seg.substring(0, 50)}...`);
                    
                    // Show next 10 segments
                    let foundHI = false;
                    for (let j = i + 1; j < Math.min(i + 15, segments.length); j++) {
                        const nextSeg = segments[j].trim();
                        const prefix = nextSeg.substring(0, 30);
                        
                        if (nextSeg.startsWith('HI*')) {
                            console.log(`  ${j}: âœ… ${prefix} <-- HI FOUND HERE`);
                            foundHI = true;
                        } else if (nextSeg.startsWith('CLM*') || nextSeg.startsWith('SE*')) {
                            console.log(`  ${j}: ${prefix} <-- Claim ended`);
                            break;
                        } else {
                            console.log(`  ${j}: ${prefix}`);
                        }
                    }
                    
                    if (!foundHI) {
                        console.log('  âŒ NO HI SEGMENT FOUND IN THIS CLAIM');
                    }
                }
            }
            
            // Count all HI segments
            const allHI = segments.filter(s => s.trim().startsWith('HI*'));
            console.log(`\n=== SUMMARY ===`);
            console.log(`Total claims: ${claimCount}`);
            console.log(`Total HI segments in file: ${allHI.length}`);
            console.log(`HI segments:`);
            allHI.forEach((hi, idx) => {
                const hiIndex = segments.findIndex(s => s.trim() === hi.trim());
                console.log(`  ${idx + 1}. Index ${hiIndex}: ${hi}`);
            });
            
            alert('EDI structure logged to console. Press F12 to view.');
        }
        
        // Quick fix: Add HI segments to all claims that don't have them
        function quickFixAllHI() {
            console.log('\n=== QUICK FIX ALL HI ===');
            
            const data = document.getElementById('validateInput').value;
            let segments = data.split('~').filter(s => s.trim());
            
            console.log('Starting segments:', segments.length);
            
            let added = 0;
            let i = 0;
            
            // Process in reverse to avoid index shifts
            for (i = segments.length - 1; i >= 0; i--) {
                const seg = segments[i].trim();
                
                if (seg.startsWith('CLM*')) {
                    // Check if next segment is HI
                    const nextSeg = i + 1 < segments.length ? segments[i + 1].trim() : '';
                    
                    if (!nextSeg.startsWith('HI*')) {
                        // No HI segment found, add one
                        console.log(`Adding HI after CLM at index ${i}:`);
                        console.log(`  CLM: ${seg.substring(0, 40)}`);
                        console.log(`  Next was: ${nextSeg.substring(0, 30)}`);
                        
                        segments.splice(i + 1, 0, 'HI*ABK:R079');
                        added++;
                        console.log(`  âœ… Inserted HI at index ${i + 1}`);
                    } else {
                        console.log(`Skipping CLM at index ${i} - already has HI`);
                    }
                }
            }
            
            console.log(`\n=== QUICK FIX COMPLETE ===`);
            console.log(`HI segments added: ${added}`);
            console.log(`Total segments now: ${segments.length}`);
            
            // Update data
            const newData = segments.join('~');
            currentValidatedData = newData;
            document.getElementById('validateInput').value = newData;
            
            console.log('Data updated, length:', newData.length);
            
            // Show result
            alert(`âœ… Added ${added} HI segment${added !== 1 ? 's' : ''} to claims!\n\nRe-validating now...`);
            
            // Re-validate
            setTimeout(() => {
                runValidation();
            }, 500);
        }
        
        // Master workflow: Fix all data issues, then prompt for mapping fixes
        function fixEverythingWorkflow() {
            console.log('=== FIX EVERYTHING WORKFLOW ===');
            
            const allIssues = [...validationErrors, ...validationWarnings];
            const fixableIssues = allIssues.filter(i => i.fixable);
            const unfixableIssues = allIssues.filter(i => !i.fixable);
            
            console.log('Fixable issues:', fixableIssues.length);
            console.log('Unfixable issues:', unfixableIssues.length);
            
            if (fixableIssues.length === 0 && unfixableIssues.length === 0) {
                showNotification('No issues to fix!', 'info');
                return;
            }
            
            // Show workflow modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 20px; padding: 3rem; max-width: 600px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">âš¡</div>
                        <h2 style="font-size: 2.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            Fix Everything
                        </h2>
                        <p style="color: var(--text-secondary); font-size: 1.1rem;">
                            Complete automated workflow to get a clean EDI file
                        </p>
                    </div>
                    
                    <div style="background: var(--bg-input); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                        <div style="font-weight: 700; margin-bottom: 1rem; color: var(--primary); font-size: 1.2rem;">ðŸ“‹ Workflow Steps:</div>
                        
                        ${fixableIssues.length > 0 ? `
                            <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: var(--bg-card); border-radius: 8px;">
                                <div style="background: #10b981; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; flex-shrink: 0;">1</div>
                                <div>
                                    <div style="font-weight: 700; color: #10b981;">Auto-Fix Data Issues</div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">${fixableIssues.length} items: Invalid codes, dates, amounts</div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${unfixableIssues.length > 0 ? `
                            <div style="display: flex; align-items: start; gap: 1rem; padding: 1rem; background: var(--bg-card); border-radius: 8px;">
                                <div style="background: #f59e0b; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; flex-shrink: 0;">${fixableIssues.length > 0 ? '2' : '1'}</div>
                                <div>
                                    <div style="font-weight: 700; color: #f59e0b;">Add Missing Segments</div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">${unfixableIssues.length} items: Guided UI with templates</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="
                            flex: 1;
                            padding: 1rem;
                            background: var(--bg-input);
                            color: var(--text);
                            border: 2px solid var(--border);
                            border-radius: 12px;
                            font-weight: 700;
                            cursor: pointer;
                            font-size: 1.1rem;
                        ">
                            Cancel
                        </button>
                        <button onclick="startFixEverythingWorkflow(${fixableIssues.length}, ${unfixableIssues.length}); this.closest('div[style*=fixed]').remove();" style="
                            flex: 2;
                            padding: 1rem;
                            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-weight: 800;
                            cursor: pointer;
                            font-size: 1.1rem;
                            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
                        ">
                            Start Workflow â†’
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function startFixEverythingWorkflow(fixableCount, unfixableCount) {
            console.log('=== STARTING WORKFLOW ===');
            console.log('Step 1: Fix', fixableCount, 'data issues');
            console.log('Step 2: Add', unfixableCount, 'missing segments');
            
            if (fixableCount > 0) {
                // Step 1: Fix all data issues
                console.log('Executing Step 1: fixAllFiltered');
                fixAllFiltered('fixable');
                
                // Step 2: After a delay, open mapping assistant
                if (unfixableCount > 0) {
                    setTimeout(() => {
                        console.log('Executing Step 2: openMappingAssistant');
                        showNotification('Step 1 Complete! Now add missing segments...', 'success');
                        setTimeout(() => {
                            openMappingAssistant();
                        }, 1000);
                    }, 3000); // Wait for data fixes to complete
                }
            } else if (unfixableCount > 0) {
                // Only mapping fixes needed
                openMappingAssistant();
            }
        }
        
        // Debug function - manually check what's in the data
        function debugCurrentState() {
            console.log('\n=== DEBUG CURRENT STATE ===');
            console.log('Current data length:', currentValidatedData.length);
            console.log('Textarea length:', document.getElementById('validateInput').value.length);
            console.log('Data matches textarea:', currentValidatedData === document.getElementById('validateInput').value);
            
            const segments = currentValidatedData.split('~').filter(s => s.trim());
            console.log('Total segments:', segments.length);
            
            // Count HI segments
            const hiSegments = segments.filter(s => s.startsWith('HI*'));
            console.log('HI segments found:', hiSegments.length);
            hiSegments.forEach((seg, idx) => console.log(`  HI ${idx + 1}:`, seg));
            
            // Count CLM segments
            const clmSegments = segments.filter(s => s.startsWith('CLM*'));
            console.log('CLM segments found:', clmSegments.length);
            
            // Count DTP*472 segments
            const dtpSegments = segments.filter(s => s.startsWith('DTP*472*'));
            console.log('DTP*472 segments found:', dtpSegments.length);
            
            console.log('\n=== Current Errors ===');
            console.log('Errors array length:', validationErrors.length);
            validationErrors.forEach((err, idx) => {
                console.log(`${idx + 1}. ${err.segment}-${err.element}: ${err.message}`);
            });
        }

        function openMappingAssistant() {
            const allIssues = [...validationErrors, ...validationWarnings];
            const mappingIssues = allIssues.filter(i => !i.fixable);
            
            console.log('=== MAPPING ASSISTANT ===');
            console.log('Total mapping issues:', mappingIssues.length);
            
            // Group issues by type
            const issuesByType = {};
            mappingIssues.forEach(issue => {
                const key = `${issue.segment}`;
                if (!issuesByType[key]) {
                    issuesByType[key] = [];
                }
                issuesByType[key].push(issue);
            });
            
            console.log('Issues grouped by segment:', issuesByType);
            
            // Create assistant modal
            const modal = document.createElement('div');
            modal.id = 'mapping-assistant-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow-y: auto;
                padding: 2rem;
            `;
            
            let issuesHTML = '';
            for (const [segment, issues] of Object.entries(issuesByType)) {
                const count = issues.length;
                const firstIssue = issues[0];
                
                issuesHTML += `
                    <div style="background: var(--bg-input); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 2px solid var(--error);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: var(--error); margin-bottom: 0.5rem;">
                                    Missing ${segment} Segment${count > 1 ? 's' : ''}
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                    ${count} occurrence${count > 1 ? 's' : ''} â€¢ ${firstIssue.message}
                                </div>
                            </div>
                            <div style="background: var(--error); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 700;">
                                ${count}
                            </div>
                        </div>
                        
                        <div style="background: var(--bg-card); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--info);">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--info);">ðŸ“– Required Format:</div>
                            <code style="color: var(--success); font-family: 'JetBrains Mono', monospace;">
                                ${getSegmentTemplate(segment)}
                            </code>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Enter ${segment} Segment Data:</label>
                            <textarea id="segment-input-${segment}" placeholder="${getSegmentTemplate(segment)}" style="
                                width: 100%;
                                min-height: 80px;
                                padding: 0.75rem;
                                background: var(--bg-card);
                                border: 2px solid var(--border);
                                border-radius: 8px;
                                color: var(--text);
                                font-family: 'JetBrains Mono', monospace;
                                font-size: 0.9rem;
                                resize: vertical;
                            "></textarea>
                        </div>
                        
                        <button onclick="addMissingSegment('${segment}', ${count})" style="
                            width: 100%;
                            padding: 0.75rem;
                            background: linear-gradient(135deg, var(--success), #059669);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-weight: 700;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 0.5rem;
                        ">
                            <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add ${segment} Segment to ${count} Location${count > 1 ? 's' : ''}
                        </button>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 20px; padding: 2rem; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
                        <div>
                            <h2 style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary);">
                                ðŸ”§ Mapping Assistant
                            </h2>
                            <p style="color: var(--text-secondary); margin: 0;">
                                Add missing segments to fix structural issues
                            </p>
                        </div>
                        <button onclick="document.getElementById('mapping-assistant-modal').remove()" style="
                            background: var(--bg-input);
                            border: none;
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 1.5rem;
                            color: var(--text-secondary);
                        ">Ã—</button>
                    </div>
                    
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 12px; margin-bottom: 2rem; border-left: 4px solid var(--info);">
                        <div style="font-weight: 600; color: var(--info); margin-bottom: 0.5rem;">ðŸ’¡ How This Works:</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">
                            1. Review each missing segment below<br>
                            2. Enter the correct segment data in the template format<br>
                            3. Click "Add Segment" to insert it into all affected locations<br>
                            4. Re-validate to confirm the fixes
                        </div>
                    </div>
                    
                    ${issuesHTML}
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button onclick="document.getElementById('mapping-assistant-modal').remove()" style="
                            flex: 1;
                            padding: 1rem;
                            background: var(--bg-input);
                            color: var(--text);
                            border: 2px solid var(--border);
                            border-radius: 12px;
                            font-weight: 700;
                            cursor: pointer;
                        ">
                            Cancel
                        </button>
                        <button onclick="applyAllMappingFixes()" style="
                            flex: 1;
                            padding: 1rem;
                            background: linear-gradient(135deg, var(--primary), #2563eb);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-weight: 700;
                            cursor: pointer;
                        ">
                            Apply All & Re-validate
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function getSegmentTemplate(segment) {
            const templates = {
                'HI': 'HI*ABK:R079',
                'DTP': 'DTP*472*D8*20250116',
                'PRV': 'PRV*BI*PXC*207Q00000X',
                'REF': 'REF*6R*1',
                'NM1': 'NM1*85*2*PROVIDER NAME*****XX*1234567890',
                'N3': 'N3*123 STREET ADDRESS',
                'N4': 'N4*CITY*ST*12345'
            };
            return templates[segment] || `${segment}*[data]`;
        }

        let pendingMappingFixes = {};

        function addMissingSegment(segmentType, count) {
            const textarea = document.getElementById(`segment-input-${segmentType}`);
            const segmentData = textarea.value.trim();
            
            console.log('=== ADD MISSING SEGMENT ===');
            console.log('Segment type:', segmentType);
            console.log('Segment data:', segmentData);
            console.log('Locations to add:', count);
            
            if (!segmentData) {
                showNotification('Please enter the segment data', 'error');
                return;
            }
            
            // Validate format
            if (!segmentData.startsWith(segmentType + '*')) {
                showNotification(`Segment must start with ${segmentType}*`, 'error');
                return;
            }
            
            // Store for later application
            pendingMappingFixes[segmentType] = segmentData;
            
            // Visual feedback
            textarea.style.border = '2px solid var(--success)';
            textarea.disabled = true;
            
            const button = event.target;
            button.innerHTML = `
                <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Ready to Add (${count} location${count > 1 ? 's' : ''})
            `;
            button.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
            button.disabled = true;
            
            showNotification(`âœ“ ${segmentType} segment prepared for ${count} location${count > 1 ? 's' : ''}`, 'success');
        }

        function applyAllMappingFixes() {
            console.log('=== APPLY ALL MAPPING FIXES ===');
            console.log('Pending fixes:', pendingMappingFixes);
            console.log('Keys to add:', Object.keys(pendingMappingFixes));
            
            if (Object.keys(pendingMappingFixes).length === 0) {
                showNotification('Please prepare at least one segment fix first by entering data and clicking "Add Segment"', 'error');
                return;
            }
            
            const allIssues = [...validationErrors, ...validationWarnings];
            const mappingIssues = allIssues.filter(i => !i.fixable);
            
            console.log('Total issues:', allIssues.length);
            console.log('Mapping issues to fix:', mappingIssues.length);
            
            let segments = currentValidatedData.split('~').filter(s => s.trim());
            console.log('Total segments before:', segments.length);
            console.log('Current data length:', currentValidatedData.length);
            
            let addedCount = 0;
            let insertionLog = [];
            
            // Group issues by claim to insert HI segments properly
            const issuesByLocation = {};
            mappingIssues.forEach(issue => {
                const key = issue.segmentIndex !== undefined ? issue.segmentIndex : 'header';
                if (!issuesByLocation[key]) {
                    issuesByLocation[key] = [];
                }
                issuesByLocation[key].push(issue);
            });
            
            console.log('Issues grouped by location:', issuesByLocation);
            
            // Sort issues by segment index in DESCENDING order
            // This ensures we insert from bottom to top, preventing index shifts
            const sortedIssues = mappingIssues.sort((a, b) => {
                const indexA = a.segmentIndex !== undefined ? a.segmentIndex : 999999;
                const indexB = b.segmentIndex !== undefined ? b.segmentIndex : 999999;
                return indexB - indexA; // Descending order
            });
            
            console.log('Sorted issues (descending by index):', sortedIssues.length);
            
            // Log what we're about to do
            console.log('\n=== INSERTION PLAN ===');
            sortedIssues.forEach((issue, idx) => {
                const segmentToAdd = pendingMappingFixes[issue.segment];
                if (segmentToAdd) {
                    console.log(`${idx + 1}. Will add ${issue.segment} at index ${issue.segmentIndex} (${segmentToAdd})`);
                }
            });
            
            // Process each issue
            for (const issue of sortedIssues) {
                    const segmentToAdd = pendingMappingFixes[issue.segment];
                    if (!segmentToAdd) {
                        console.log(`Skipping ${issue.segment} - no pending fix prepared`);
                        continue;
                    }
                    
                    console.log(`\n--- Adding ${issue.segment} ---`);
                    console.log('Segment to add:', segmentToAdd);
                    console.log('Target index:', issue.segmentIndex);
                    console.log('Location:', location);
                    
                    // Insert segment at appropriate location
                    // HI should come AFTER CLM, not before
                    if (issue.segmentIndex !== undefined && issue.segmentIndex >= 0 && issue.segmentIndex < segments.length) {
                        console.log('Context - segment at index:', segments[issue.segmentIndex]);
                        
                        // For HI segments, insert AFTER the CLM segment
                        if (issue.segment === 'HI' && segments[issue.segmentIndex].startsWith('CLM*')) {
                            console.log('Inserting HI AFTER CLM at index:', issue.segmentIndex + 1);
                            segments.splice(issue.segmentIndex + 1, 0, segmentToAdd);
                            insertionLog.push(`${issue.segment} AFTER CLM at index ${issue.segmentIndex + 1}`);
                        }
                        // For DTP segments after service line, insert after the service line segment
                        else if (issue.segment === 'DTP' && segments[issue.segmentIndex].startsWith('SV1*')) {
                            console.log('Inserting DTP AFTER SV1 at index:', issue.segmentIndex + 1);
                            segments.splice(issue.segmentIndex + 1, 0, segmentToAdd);
                            insertionLog.push(`${issue.segment} AFTER SV1 at index ${issue.segmentIndex + 1}`);
                        }
                        // Default: insert at the specified index (before)
                        else {
                            console.log('Inserting at index:', issue.segmentIndex);
                            segments.splice(issue.segmentIndex, 0, segmentToAdd);
                            insertionLog.push(`${issue.segment} at index ${issue.segmentIndex}`);
                        }
                    } else if (issue.segmentIndex !== undefined) {
                        // Add after a specific segment (for claim-level segments)
                        console.log('Adding after segment at index:', issue.segmentIndex);
                        segments.splice(issue.segmentIndex + 1, 0, segmentToAdd);
                        insertionLog.push(`${issue.segment} after index ${issue.segmentIndex}`);
                    } else {
                        // Find appropriate location based on segment type
                        let insertIndex = -1;
                        
                        if (issue.segment === 'HI') {
                            // HI should come after CLM segment
                            for (let i = segments.length - 1; i >= 0; i--) {
                                if (segments[i].startsWith('CLM*')) {
                                    insertIndex = i + 1;
                                    console.log('Found CLM at', i, '- inserting HI at', insertIndex);
                                    break;
                                }
                            }
                        } else if (issue.segment === 'DTP') {
                            // DTP should come after HI or CLM
                            for (let i = segments.length - 1; i >= 0; i--) {
                                if (segments[i].startsWith('HI*') || segments[i].startsWith('CLM*')) {
                                    insertIndex = i + 1;
                                    console.log('Found', segments[i].substring(0, 3), 'at', i, '- inserting DTP at', insertIndex);
                                    break;
                                }
                            }
                        }
                        
                        if (insertIndex > 0) {
                            segments.splice(insertIndex, 0, segmentToAdd);
                            insertionLog.push(`${issue.segment} at calculated index ${insertIndex}`);
                        } else {
                            // Add to end if no specific location found
                            console.log('No specific location found - adding to end');
                            segments.push(segmentToAdd);
                            insertionLog.push(`${issue.segment} at end`);
                        }
                    }
                    
                    addedCount++;
                    console.log('Added count now:', addedCount);
            }
            
            // Update data
            const newData = segments.join('~');
            console.log('\n=== UPDATE COMPLETE ===');
            console.log('Total segments after:', segments.length);
            console.log('Segments added:', addedCount);
            console.log('Old data length:', currentValidatedData.length);
            console.log('New data length:', newData.length);
            console.log('Insertion log:', insertionLog);
            
            currentValidatedData = newData;
            document.getElementById('validateInput').value = newData;
            
            console.log('Textarea updated');
            
            // Close modal
            const modal = document.getElementById('mapping-assistant-modal');
            if (modal) modal.remove();
            
            // Reset pending fixes
            pendingMappingFixes = {};
            
            // Show success and re-validate
            showNotification(`âœ… Added ${addedCount} missing segment${addedCount > 1 ? 's' : ''}!`, 'success');
            
            console.log('Scheduling re-validation...');
            setTimeout(() => {
                console.log('=== CALLING RUN VALIDATION ===');
                runValidation();
                console.log('=== RUN VALIDATION RETURNED ===');
            }, 1000);
        }

        function updateSelectedErrors() {
            const checkboxes = document.querySelectorAll('.error-checkbox:checked');
            const selectedCount = checkboxes.length;
            
            console.log('=== UPDATE SELECTED ERRORS ===');
            console.log('Checked checkboxes:', selectedCount);
            console.log('Checkbox elements:', checkboxes);
            
            const fixSelectedBtn = document.getElementById('fixSelectedBtn');
            const fixSelectedText = document.getElementById('fixSelectedBtnText');
            
            console.log('Fix Selected button found:', !!fixSelectedBtn);
            console.log('Fix Selected text found:', !!fixSelectedText);
            
            if (fixSelectedBtn && fixSelectedText) {
                if (selectedCount > 0) {
                    fixSelectedBtn.style.display = 'flex';
                    fixSelectedBtn.style.opacity = '1';
                    fixSelectedBtn.style.cursor = 'pointer';
                    fixSelectedBtn.disabled = false;
                    fixSelectedText.textContent = `Fix Selected (${selectedCount})`;
                    console.log('Button enabled with', selectedCount, 'selected');
                } else {
                    fixSelectedBtn.style.display = 'none';
                    fixSelectedBtn.style.opacity = '0.5';
                    fixSelectedBtn.style.cursor = 'not-allowed';
                    fixSelectedBtn.disabled = true;
                    fixSelectedText.textContent = 'Fix Selected';
                    console.log('Button disabled - no selection');
                }
            }
        }

        function fixSelectedErrors() {
            console.log('=== FIX SELECTED ERRORS CALLED ===');
            
            const checkboxes = document.querySelectorAll('.error-checkbox:checked');
            console.log('Found checked checkboxes:', checkboxes.length);
            
            if (checkboxes.length === 0) {
                alert('Please select at least one error to fix by checking the checkboxes.');
                return;
            }
            
            // Get selected issue indices
            const selectedIndices = Array.from(checkboxes).map(cb => {
                const index = parseInt(cb.dataset.index);
                console.log('Checkbox data-index:', cb.dataset.index, 'â†’ parsed:', index);
                return index;
            });
            
            console.log('Selected indices:', selectedIndices);
            
            const allIssues = [...validationErrors, ...validationWarnings];
            console.log('Total issues available:', allIssues.length);
            console.log('Validation errors:', validationErrors.length);
            console.log('Validation warnings:', validationWarnings.length);
            
            const selectedIssues = selectedIndices.map((idx, i) => {
                const issue = allIssues[idx];
                console.log(`Index ${idx}:`, issue ? `${issue.segment}-${issue.element} (fixable: ${issue.fixable})` : 'UNDEFINED');
                return issue;
            }).filter(i => i && i.fixable);
            
            console.log('Fixable selected issues:', selectedIssues.length);
            console.log('Issues to fix:', selectedIssues);
            
            if (selectedIssues.length === 0) {
                alert('None of the selected errors can be fixed automatically.\n\nThey may be structural/mapping issues that require manual correction.');
                return;
            }
            
            const confirmed = confirm(
                `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                         â•‘
â•‘   FIX ${selectedIssues.length} SELECTED ERROR(S)?        â•‘
â•‘                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ This will automatically correct:
  â€¢ Invalid codes (XXXXX â†’ R079)
  â€¢ Wrong date formats (20991301 â†’ 20250116)
  â€¢ Negative amounts (-100.00 â†’ 100.00)
  â€¢ Other validation issues

ðŸ“Š Selected: ${checkboxes.length} errors
ðŸ“Š Fixable: ${selectedIssues.length} errors

âš ï¸ IMPORTANT:
   Click [OK] to apply fixes to selected errors
   Click [Cancel] to go back without fixing`
            );
            
            if (!confirmed) {
                console.log('User cancelled');
                return;
            }
            
            console.log('User confirmed - starting fixes');
            console.log('Current data length:', currentValidatedData.length);
            
            // Show progress
            const progressDiv = document.createElement('div');
            progressDiv.id = 'fix-selected-progress';
            progressDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-card);
                padding: 2rem;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                z-index: 9999;
                min-width: 400px;
                border: 2px solid #8b5cf6;
            `;
            progressDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 2rem; font-weight: 800; color: #8b5cf6;">
                        Fixing Selected Errors...
                    </div>
                    <div style="font-size: 1.2rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        <span id="selected-fix-progress-count">0</span> / ${selectedIssues.length}
                    </div>
                </div>
                <div style="background: var(--bg-input); height: 30px; border-radius: 15px; overflow: hidden;">
                    <div id="selected-fix-progress-bar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); 
                         height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
            `;
            document.body.appendChild(progressDiv);
            
            // Apply fixes
            let segments = currentValidatedData.split('~').filter(s => s.trim());
            console.log('Total segments to work with:', segments.length);
            console.log('First segment:', segments[0]);
            console.log('Last segment:', segments[segments.length - 1]);
            let fixCount = 0;
            
            selectedIssues.forEach((issue, idx) => {
                console.log(`\n--- Fix ${idx + 1}/${selectedIssues.length} ---`);
                console.log('Issue:', issue.segment, issue.element);
                console.log('Segment index:', issue.segmentIndex);
                console.log('Suggested value:', issue.suggestedValue);
                
                // Update progress
                const progressBar = document.getElementById('selected-fix-progress-bar');
                const progressCount = document.getElementById('selected-fix-progress-count');
                if (progressBar && progressCount) {
                    const percent = Math.round(((idx + 1) / selectedIssues.length) * 100);
                    progressBar.style.width = percent + '%';
                    progressCount.textContent = idx + 1;
                }
                
                try {
                    let fixed = false;
                    
                    if (issue.segmentIndex !== undefined && issue.segmentIndex >= 0 && issue.segmentIndex < segments.length) {
                        const segment = segments[issue.segmentIndex];
                        console.log('Original segment:', segment);
                        
                        if (!segment) {
                            console.warn('Segment is empty/undefined');
                            return;
                        }
                        
                        const elements = segment.split('*');
                        console.log('Elements:', elements.length);
                        
                        if (issue.segment === 'HI') {
                            const match = issue.element.match(/HI0(\d+)/);
                            if (match) {
                                const elemIdx = parseInt(match[1]);
                                console.log('HI element index:', elemIdx);
                                if (elements[elemIdx]) {
                                    const parts = elements[elemIdx].split(':');
                                    if (parts.length >= 2) {
                                        console.log('Old value:', parts[1], 'â†’ New value:', issue.suggestedValue);
                                        parts[1] = issue.suggestedValue;
                                        elements[elemIdx] = parts.join(':');
                                        segments[issue.segmentIndex] = elements.join('*');
                                        console.log('Modified segment:', segments[issue.segmentIndex]);
                                        fixed = true;
                                    }
                                }
                            }
                        } else if (issue.segment === 'SV1') {
                            if (issue.element === 'SV101') {
                                console.log('Fixing SV101');
                                const parts = elements[1].split(':');
                                if (parts.length >= 2) {
                                    console.log('Old value:', parts[1], 'â†’ New value:', issue.suggestedValue);
                                    parts[1] = issue.suggestedValue;
                                    elements[1] = parts.join(':');
                                    segments[issue.segmentIndex] = elements.join('*');
                                    console.log('Modified segment:', segments[issue.segmentIndex]);
                                    fixed = true;
                                }
                            } else if (issue.element === 'SV102') {
                                console.log('Fixing SV102');
                                console.log('Old value:', elements[2], 'â†’ New value:', issue.suggestedValue);
                                elements[2] = issue.suggestedValue;
                                segments[issue.segmentIndex] = elements.join('*');
                                console.log('Modified segment:', segments[issue.segmentIndex]);
                                fixed = true;
                            }
                        } else if (issue.segment === 'CLM') {
                            console.log('Fixing CLM02');
                            console.log('Old value:', elements[2], 'â†’ New value:', issue.suggestedValue);
                            elements[2] = issue.suggestedValue;
                            segments[issue.segmentIndex] = elements.join('*');
                            console.log('Modified segment:', segments[issue.segmentIndex]);
                            fixed = true;
                        } else if (issue.segment === 'DTP') {
                            console.log('Fixing DTP03');
                            console.log('Old value:', elements[3], 'â†’ New value:', issue.suggestedValue);
                            elements[3] = issue.suggestedValue;
                            segments[issue.segmentIndex] = elements.join('*');
                            console.log('Modified segment:', segments[issue.segmentIndex]);
                            fixed = true;
                        }
                    } else {
                        console.log('Fixing ISA/GS level');
                        // ISA/GS level
                        for (let i = 0; i < segments.length; i++) {
                            if (segments[i].trim().startsWith(issue.segment + '*')) {
                                console.log('Found segment at index', i);
                                const elements = segments[i].split('*');
                                const match = issue.element.match(/\d+$/);
                                if (match) {
                                    const elemNum = parseInt(match[0]);
                                    console.log('Element number:', elemNum);
                                    if (elements[elemNum]) {
                                        console.log('Old value:', elements[elemNum], 'â†’ New value:', issue.suggestedValue);
                                        elements[elemNum] = issue.suggestedValue;
                                        segments[i] = elements.join('*');
                                        console.log('Modified segment:', segments[i]);
                                        fixed = true;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                    
                    if (fixed) {
                        fixCount++;
                        console.log('âœ“ Fix applied successfully (#' + fixCount + ')');
                    } else {
                        console.warn('âœ— Fix failed');
                    }
                } catch (error) {
                    console.error('âœ— Exception:', error);
                }
            });
            
            // Update data
            console.log('\n=== JOINING SEGMENTS ===');
            console.log('Total segments to join:', segments.length);
            console.log('Sample modified segments:');
            selectedIssues.forEach((issue, idx) => {
                if (issue.segmentIndex !== undefined && segments[issue.segmentIndex]) {
                    console.log(`  Segment ${issue.segmentIndex}:`, segments[issue.segmentIndex]);
                }
            });
            
            const newData = segments.join('~');
            console.log('\n=== FIX COMPLETE ===');
            console.log('Fixes applied:', fixCount, '/', selectedIssues.length);
            console.log('Old data length:', currentValidatedData.length);
            console.log('New data length:', newData.length);
            console.log('Data changed:', currentValidatedData !== newData);
            console.log('Length difference:', newData.length - currentValidatedData.length);
            
            // Show first 500 chars of old vs new for comparison
            console.log('\nOld data sample (first 500 chars):');
            console.log(currentValidatedData.substring(0, 500));
            console.log('\nNew data sample (first 500 chars):');
            console.log(newData.substring(0, 500));
            
            currentValidatedData = newData;
            const textarea = document.getElementById('validateInput');
            textarea.value = newData;
            
            console.log('\nTextarea updated - value length:', textarea.value.length);
            console.log('currentValidatedData updated - length:', currentValidatedData.length);
            console.log('Textarea matches currentValidatedData:', textarea.value === currentValidatedData);
            
            // Remove progress
            const progressElement = document.getElementById('fix-selected-progress');
            if (progressElement) progressElement.remove();
            
            // Show result
            showNotification(`âœ… Fixed ${fixCount} of ${selectedIssues.length} selected errors!`, 'success');
            
            // Uncheck all checkboxes
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedErrors();
            
            // Re-validate
            console.log('Scheduling re-validation in 1.5 seconds...');
            setTimeout(() => {
                console.log('=== RE-VALIDATION STARTING ===');
                console.log('Reading from textarea, length:', document.getElementById('validateInput').value.length);
                console.log('currentValidatedData length:', currentValidatedData.length);
                runValidation();
                console.log('=== RE-VALIDATION COMPLETE ===');
                console.log('New error count:', validationErrors.length);
                console.log('New warning count:', validationWarnings.length);
            }, 1500);
        }

        function fixAllFiltered(severityType) {
            console.log('=== FIX ALL FILTERED CALLED ===');
            console.log('Severity type:', severityType);
            
            const allIssues = [...validationErrors, ...validationWarnings];
            console.log('All issues count:', allIssues.length);
            console.log('validationErrors:', validationErrors.length);
            console.log('validationWarnings:', validationWarnings.length);
            
            // Filter issues based on type
            let issuesToFix = [];
            if (severityType === 'fixable') {
                issuesToFix = allIssues.filter(i => i.fixable === true);
            } else if (severityType === 'critical') {
                issuesToFix = allIssues.filter(i => i.severity === 'critical' && i.fixable === true);
            } else if (severityType === 'error') {
                issuesToFix = allIssues.filter(i => i.severity === 'error' && i.fixable === true);
            } else if (severityType === 'warning') {
                issuesToFix = allIssues.filter(i => i.severity === 'warning' && i.fixable === true);
            }
            
            console.log('Issues to fix:', issuesToFix.length);
            
            if (issuesToFix.length === 0) {
                showNotification('No fixable issues found!', 'error');
                return;
            }
            
            // Show processing notification (no confirm needed - just proceed)
            showNotification(`Fixing ${issuesToFix.length} issues...`, 'info');
            
            // Get current data
            let data = document.getElementById('validateInput').value;
            let segments = data.split('~').map(s => s.trim()).filter(s => s);
            
            console.log('Starting segments:', segments.length);
            console.log('Starting data length:', data.length);
            
            let fixedCount = 0;
            
            // Process each issue
            issuesToFix.forEach((issue, idx) => {
                console.log(`\n[${idx + 1}/${issuesToFix.length}] Fixing ${issue.segment}-${issue.element}`);
                
                let segIdx = issue.segmentIndex;
                let fixed = false;
                
                // If no segmentIndex, search for the segment
                if (segIdx === undefined || segIdx < 0 || segIdx >= segments.length) {
                    console.log('  ðŸ” Searching for segment', issue.segment);
                    for (let i = 0; i < segments.length; i++) {
                        if (segments[i].trim().startsWith(issue.segment + '*')) {
                            segIdx = i;
                            console.log('  ðŸ“ Found at index:', segIdx);
                            break;
                        }
                    }
                    if (segIdx === undefined || segIdx < 0) {
                        console.log('  âŒ Segment not found');
                        return;
                    }
                }
                
                const segment = segments[segIdx];
                if (!segment) {
                    console.log('  âŒ Segment not found');
                    return;
                }
                
                console.log('  Original:', segment.substring(0, 80));
                
                // Split into elements
                const parts = segment.split('*');
                
                // Fix based on segment type
                if (issue.segment === 'CLM' && issue.element === 'CLM02') {
                    // Fix claim amount
                    if (parts[2] !== undefined) {
                        console.log('  Old CLM02:', parts[2]);
                        parts[2] = issue.suggestedValue || '100.00';
                        console.log('  New CLM02:', parts[2]);
                        fixed = true;
                    }
                } else if (issue.segment === 'SV1' && issue.element === 'SV101') {
                    // Fix procedure code
                    if (parts[1]) {
                        const svcParts = parts[1].split(':');
                        if (svcParts.length >= 2) {
                            console.log('  Old code:', svcParts[1]);
                            svcParts[1] = issue.suggestedValue || '99213';
                            parts[1] = svcParts.join(':');
                            console.log('  New code:', svcParts[1]);
                            fixed = true;
                        }
                    }
                } else if (issue.segment === 'SV1' && issue.element === 'SV102') {
                    // Fix line item charge amount
                    if (parts[2] !== undefined) {
                        console.log('  Old SV102:', parts[2]);
                        parts[2] = issue.suggestedValue || '75.00';
                        console.log('  New SV102:', parts[2]);
                        fixed = true;
                    }
                } else if (issue.segment === 'DTP' && issue.element === 'DTP03') {
                    // Fix date
                    if (parts[3] !== undefined) {
                        console.log('  Old date:', parts[3]);
                        parts[3] = issue.suggestedValue || new Date().toISOString().slice(0,10).replace(/-/g, '');
                        console.log('  New date:', parts[3]);
                        fixed = true;
                    }
                } else if (issue.segment === 'HI') {
                    // Fix diagnosis code
                    const match = issue.element.match(/HI0(\d+)/);
                    if (match && parts[parseInt(match[1])]) {
                        const elemIdx = parseInt(match[1]);
                        const hiParts = parts[elemIdx].split(':');
                        if (hiParts.length >= 2) {
                            console.log('  Old diagnosis:', hiParts[1]);
                            hiParts[1] = issue.suggestedValue || 'R079';
                            parts[elemIdx] = hiParts.join(':');
                            console.log('  New diagnosis:', hiParts[1]);
                            fixed = true;
                        }
                    }
                } else if (issue.segment === 'ISA' || issue.segment === 'GS' || issue.segment === 'ST') {
                    // Fix header segment elements - extract element number from element name
                    const match = issue.element.match(/(\d+)$/);
                    if (match) {
                        const elemNum = parseInt(match[1]);
                        if (parts[elemNum] !== undefined && issue.suggestedValue) {
                            console.log(`  Old ${issue.element}:`, parts[elemNum]);
                            parts[elemNum] = issue.suggestedValue;
                            console.log(`  New ${issue.element}:`, parts[elemNum]);
                            fixed = true;
                        }
                    }
                }
                
                if (fixed) {
                    segments[segIdx] = parts.join('*');
                    console.log('  âœ… Fixed:', segments[segIdx].substring(0, 80));
                    fixedCount++;
                } else {
                    console.log('  âš ï¸ Could not fix this issue - check element type handler');
                }
            });
            
            console.log('\n=== FIX SUMMARY ===');
            console.log('Fixed:', fixedCount, '/', issuesToFix.length);
            
            // Update data
            const newData = segments.join('~');
            currentValidatedData = newData;
            document.getElementById('validateInput').value = newData;
            
            console.log('New data length:', newData.length);
            
            // Show success notification
            showNotification(`âœ… Fixed ${fixedCount} of ${issuesToFix.length} issues! Re-validating...`, 'success');
            
            // Re-validate
            setTimeout(() => {
                runValidation();
            }, 500);
        } // End of fixAllFiltered

        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            const color = type === 'success' ? 'var(--success)' : 
                         type === 'error' ? 'var(--error)' : 'var(--info)';
            
            toast.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                background: ${color};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideInRight 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        function updateErrorDashboard() {
            // Calculate total issues first
            const totalIssues = validationErrors.length + validationWarnings.length;
            
            // Categorize errors by type
            const errorsByType = {
                codeErrors: [],
                dateErrors: [],
                amountErrors: [],
                structureErrors: []
            };

            validationErrors.forEach(error => {
                if (error.segment === 'HI' || error.segment === 'SV1' || error.segment === 'ISA') {
                    errorsByType.codeErrors.push(error);
                } else if (error.segment === 'DTP') {
                    errorsByType.dateErrors.push(error);
                } else if (error.segment === 'CLM' || (error.segment === 'SV1' && error.element === 'SV102')) {
                    errorsByType.amountErrors.push(error);
                } else {
                    errorsByType.structureErrors.push(error);
                }
            });

            validationWarnings.forEach(warning => {
                if (warning.segment === 'DTP') {
                    errorsByType.dateErrors.push(warning);
                } else if (warning.segment === 'CLM' || warning.segment === 'SV1') {
                    errorsByType.amountErrors.push(warning);
                } else {
                    errorsByType.structureErrors.push(warning);
                }
            });

            // Update the live stats banner
            const dashboardTab = document.getElementById('dashboardTab');
            if (dashboardTab) {
                // Check if live stats banner already exists
                let liveBanner = dashboardTab.querySelector('.live-stats-banner');
                if (!liveBanner) {
                    // Create live stats banner at the top of dashboard
                    liveBanner = document.createElement('div');
                    liveBanner.className = 'live-stats-banner';
                    liveBanner.style.cssText = `
                        background: linear-gradient(135deg, var(--primary), var(--secondary));
                        color: white;
                        padding: 1.5rem 2rem;
                        border-radius: 12px;
                        margin-bottom: 2rem;
                        animation: slideIn 0.5s ease;
                    `;
                    dashboardTab.querySelector('.card').insertBefore(liveBanner, dashboardTab.querySelector('.info-box'));
                }

                const lastValidated = new Date().toLocaleTimeString();

                liveBanner.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.25rem;">
                                ðŸ”´ LIVE VALIDATION RESULTS
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 800;">
                                ${totalIssues} Issue${totalIssues !== 1 ? 's' : ''} Found
                            </div>
                            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 0.25rem;">
                                Last validated: ${lastValidated}
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">
                                    ${errorsByType.codeErrors.length}
                                </div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Code Errors</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">
                                    ${errorsByType.dateErrors.length}
                                </div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Date Errors</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">
                                    ${errorsByType.amountErrors.length}
                                </div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Amount Errors</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">
                                    ${errorsByType.structureErrors.length}
                                </div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">Structure Errors</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Update the summary stats at the bottom with live data
            const summaryCard = dashboardTab.querySelector('.card[style*="linear-gradient"]');
            if (summaryCard) {
                const statsDiv = summaryCard.querySelector('div[style*="grid-template-columns"]');
                if (statsDiv) {
                    const criticalCount = validationErrors.filter(e => e.severity === 'critical').length;
                    const errorCount = validationErrors.filter(e => e.severity === 'error').length;
                    const warningCount = validationWarnings.length;

                    statsDiv.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">${totalIssues}</div>
                            <div style="font-size: 1.1rem; opacity: 0.9;">Total Issues (Live)</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">${criticalCount}</div>
                            <div style="font-size: 1.1rem; opacity: 0.9;">Critical Errors</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">${errorCount}</div>
                            <div style="font-size: 1.1rem; opacity: 0.9;">Standard Errors</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;">${warningCount}</div>
                            <div style="font-size: 1.1rem; opacity: 0.9;">Warnings</div>
                        </div>
                    `;
                }
            }

            // Add error breakdown sections with actual found errors
            addErrorBreakdownCards(errorsByType);
        }

        function addErrorBreakdownCards(errorsByType) {
            const dashboardTab = document.getElementById('dashboardTab');
            if (!dashboardTab) return;

            // Find or create the live errors section
            let liveSection = dashboardTab.querySelector('.live-errors-section');
            if (!liveSection) {
                liveSection = document.createElement('div');
                liveSection.className = 'live-errors-section';
                liveSection.style.cssText = 'margin-top: 2rem; margin-bottom: 2rem;';
                
                // Insert before the summary stats card
                const summaryCard = dashboardTab.querySelector('.card[style*="linear-gradient"]');
                if (summaryCard) {
                    summaryCard.parentNode.insertBefore(liveSection, summaryCard);
                }
            }

            // Build the live errors breakdown
            let html = `
                <div class="card" style="background: rgba(239, 68, 68, 0.1); border: 2px solid var(--error);">
                    <h3 style="color: var(--error); display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                        <svg style="width: 28px; height: 28px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        Live Errors Found in Last Validation
                    </h3>
                    <div style="display: grid; gap: 1rem;">
            `;

            // Code Errors
            if (errorsByType.codeErrors.length > 0) {
                html += `
                    <div class="error-card" style="border-color: var(--error);">
                        <div class="error-card-header">Code Errors (${errorsByType.codeErrors.length})</div>
                        <div class="error-card-body" style="max-height: 200px; overflow-y: auto;">
                            ${errorsByType.codeErrors.map(e => `
                                <div style="padding: 0.5rem; margin: 0.25rem 0; background: var(--bg-dark); border-radius: 6px; border-left: 3px solid var(--error);">
                                    <strong>${e.segment}-${e.element}:</strong> ${e.message}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Date Errors
            if (errorsByType.dateErrors.length > 0) {
                html += `
                    <div class="error-card" style="border-color: var(--warning);">
                        <div class="error-card-header">Date/Time Errors (${errorsByType.dateErrors.length})</div>
                        <div class="error-card-body" style="max-height: 200px; overflow-y: auto;">
                            ${errorsByType.dateErrors.map(e => `
                                <div style="padding: 0.5rem; margin: 0.25rem 0; background: var(--bg-dark); border-radius: 6px; border-left: 3px solid var(--warning);">
                                    <strong>${e.segment}-${e.element}:</strong> ${e.message}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Amount Errors
            if (errorsByType.amountErrors.length > 0) {
                html += `
                    <div class="error-card" style="border-color: var(--accent);">
                        <div class="error-card-header">Amount Errors (${errorsByType.amountErrors.length})</div>
                        <div class="error-card-body" style="max-height: 200px; overflow-y: auto;">
                            ${errorsByType.amountErrors.map(e => `
                                <div style="padding: 0.5rem; margin: 0.25rem 0; background: var(--bg-dark); border-radius: 6px; border-left: 3px solid var(--accent);">
                                    <strong>${e.segment}-${e.element}:</strong> ${e.message}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Structure Errors
            if (errorsByType.structureErrors.length > 0) {
                html += `
                    <div class="error-card" style="border-color: var(--info);">
                        <div class="error-card-header">Structure/Mapping Errors (${errorsByType.structureErrors.length})</div>
                        <div class="error-card-body" style="max-height: 200px; overflow-y: auto;">
                            ${errorsByType.structureErrors.map(e => `
                                <div style="padding: 0.5rem; margin: 0.25rem 0; background: var(--bg-dark); border-radius: 6px; border-left: 3px solid var(--info);">
                                    <strong>${e.segment}-${e.element}:</strong> ${e.message}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (errorsByType.codeErrors.length === 0 && errorsByType.dateErrors.length === 0 && 
                errorsByType.amountErrors.length === 0 && errorsByType.structureErrors.length === 0) {
                html += `
                    <div class="info-box" style="background: rgba(16, 185, 129, 0.1); border-color: var(--success); text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âœ…</div>
                        <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">No Errors Found!</div>
                        <div style="color: var(--text-secondary);">Your EDI data passed all validation checks.</div>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            liveSection.innerHTML = html;
        }
    </script>
</body>
</html>
